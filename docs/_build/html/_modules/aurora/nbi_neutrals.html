

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>aurora.nbi_neutrals &mdash; aurora 1.0.0 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> aurora
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../aurora.html">aurora package</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">aurora</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>aurora.nbi_neutrals</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for aurora.nbi_neutrals</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*-Python-*-</span>
<span class="c1"># Created by sciortinof at 31 Jul 2020  09:11</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Methods for neutral beam analysis, particularly in relation to impurity transport studies.</span>
<span class="sd">These script collects functions that should be device-agnostic.</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">RectBivariateSpline</span>
<span class="kn">import</span> <span class="nn">copy</span>

<span class="kn">from</span> <span class="nn">.janev_smith_rates</span> <span class="kn">import</span> <span class="n">js_sigma</span>


<div class="viewcode-block" id="get_neutrals_fsa"><a class="viewcode-back" href="../../aurora.html#aurora.nbi_neutrals.get_neutrals_fsa">[docs]</a><span class="k">def</span> <span class="nf">get_neutrals_fsa</span><span class="p">(</span><span class="n">neutrals</span><span class="p">,</span> <span class="n">geqdsk</span><span class="p">,</span> <span class="n">debug_plots</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute charge exchange recombination for a given impurity with neutral beam components,</span>
<span class="sd">    obtaining rates in [s^-1] units. This method expects all neutral components to be given in a</span>
<span class="sd">    dictionary with a structure that is independent of NBI model (i.e. coming from FIDASIM, NUBEAM, </span>
<span class="sd">    pencil calculations, etc.).</span>

<span class="sd">    Args:</span>
<span class="sd">        neutrals : dict</span>
<span class="sd">            Dictionary containing fields</span>
<span class="sd">            {&quot;beams&quot;,&quot;names&quot;,&quot;R&quot;,&quot;Z&quot;, beam1, beam2, etc.}</span>
<span class="sd">            Here beam1,beam2,etc. are the names in neutrals[&quot;beams&quot;]. &quot;names&quot; are the names of each </span>
<span class="sd">            beam component, e.g. &#39;fdens&#39;,&#39;hdens&#39;,&#39;halo&#39;, etc., ordered according to &quot;names&quot;. </span>
<span class="sd">            &quot;R&quot;,&quot;Z&quot; are the major radius and vertical coordinates [cm] on which neutral density components are </span>
<span class="sd">            given in elements such as</span>
<span class="sd">    </span>
<span class="sd">            .. code-block:: python</span>
<span class="sd">            </span>
<span class="sd">                neutrals[beams[0]][&quot;n=0&quot;][name_idx]</span>

<span class="sd">            It is currently assumed that n=0,1 and 2 beam components are provided by the user. </span>

<span class="sd">        geqdsk : gEQDSK post-processed dictionary, as given by the omfit_eqdsk package. </span>

<span class="sd">        debug_plots : bool, optional</span>
<span class="sd">            If True, various plots are displayed. </span>

<span class="sd">    Returns:</span>
<span class="sd">        neut_fsa : dict</span>
<span class="sd">             Dictionary of flux-surface-averaged (FSA) neutral densities, in the same units as in the input. </span>
<span class="sd">             Similarly to the input &quot;neutrals&quot;, this dictionary has a structure like</span>

<span class="sd">             .. code-block:: python</span>
<span class="sd">             </span>
<span class="sd">                 neutrals_ext[beam][f&#39;n={n_level}&#39;][name_idx]</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">beams</span> <span class="o">=</span> <span class="n">neutrals</span><span class="p">[</span><span class="s1">&#39;beams&#39;</span><span class="p">]</span>
    <span class="n">names</span> <span class="o">=</span> <span class="n">neutrals</span><span class="p">[</span><span class="s1">&#39;names&#39;</span><span class="p">]</span>
    <span class="n">zz</span> <span class="o">=</span> <span class="n">neutrals</span><span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1e2</span>  <span class="c1"># cm --&gt; m</span>
    <span class="n">rr</span> <span class="o">=</span> <span class="n">neutrals</span><span class="p">[</span><span class="s1">&#39;R&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1e2</span>  <span class="c1"># cm --&gt; m</span>

    <span class="k">if</span> <span class="n">debug_plots</span><span class="p">:</span>
        <span class="c1"># for debugging/plotting:</span>
        <span class="n">RBBBS</span> <span class="o">=</span> <span class="n">geqdsk</span><span class="p">[</span><span class="s1">&#39;RBBBS&#39;</span><span class="p">]</span>
        <span class="n">ZBBBS</span> <span class="o">=</span> <span class="n">geqdsk</span><span class="p">[</span><span class="s1">&#39;ZBBBS&#39;</span><span class="p">]</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">rr</span><span class="p">,</span> <span class="n">zz</span><span class="p">,</span> <span class="n">neutrals</span><span class="p">[</span><span class="n">beams</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;n=0&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">RBBBS</span><span class="p">,</span> <span class="n">ZBBBS</span><span class="p">,</span> <span class="s1">&#39;w--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;R [m]&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Z [m]&#39;</span><span class="p">)</span>

    <span class="c1"># simple way to find rhop at any combination of R,Z coords:</span>
    <span class="n">RHOpRZ</span> <span class="o">=</span> <span class="n">geqdsk</span><span class="p">[</span><span class="s1">&#39;AuxQuantities&#39;</span><span class="p">][</span><span class="s1">&#39;RHOpRZ&#39;</span><span class="p">]</span>
    <span class="n">Rgrid</span> <span class="o">=</span> <span class="n">geqdsk</span><span class="p">[</span><span class="s1">&#39;AuxQuantities&#39;</span><span class="p">][</span><span class="s1">&#39;R&#39;</span><span class="p">]</span>  <span class="c1"># m</span>
    <span class="n">Zgrid</span> <span class="o">=</span> <span class="n">geqdsk</span><span class="p">[</span><span class="s1">&#39;AuxQuantities&#39;</span><span class="p">][</span><span class="s1">&#39;Z&#39;</span><span class="p">]</span>  <span class="c1"># m</span>

    <span class="c1"># extrapolate beam to cover the entire 2D poloidal cross section,</span>
    <span class="c1"># setting all neutral populations to 0 outside of the simulated region</span>
    <span class="n">neutrals_ext</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="n">beams</span><span class="p">:</span>
        <span class="n">neutrals_ext</span><span class="p">[</span><span class="n">beam</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">n_level</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]:</span>
            <span class="n">neutrals_ext</span><span class="p">[</span><span class="n">beam</span><span class="p">][</span><span class="sa">f</span><span class="s1">&#39;n=</span><span class="si">{</span><span class="n">n_level</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">names</span><span class="p">):</span>
                <span class="n">dens</span> <span class="o">=</span> <span class="n">neutrals</span><span class="p">[</span><span class="n">beam</span><span class="p">][</span><span class="sa">f</span><span class="s1">&#39;n=</span><span class="si">{</span><span class="n">n_level</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">]</span>

                <span class="n">f</span> <span class="o">=</span> <span class="n">interp2d</span><span class="p">(</span><span class="n">rr</span><span class="p">,</span> <span class="n">zz</span><span class="p">,</span> <span class="n">dens</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">Rgrid</span><span class="p">,</span> <span class="n">Zgrid</span><span class="p">)</span>

                <span class="n">tmp</span><span class="p">[</span><span class="n">tmp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">neutrals_ext</span><span class="p">[</span><span class="n">beam</span><span class="p">][</span><span class="sa">f</span><span class="s1">&#39;n=</span><span class="si">{</span><span class="n">n_level</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">][</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span>

    <span class="k">if</span> <span class="n">debug_plots</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">CS</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">Rgrid</span><span class="p">,</span> <span class="n">Zgrid</span><span class="p">,</span> <span class="n">neutrals_ext</span><span class="p">[</span><span class="n">beam</span><span class="p">][</span><span class="s1">&#39;n=0&#39;</span><span class="p">][</span><span class="s1">&#39;fdens&#39;</span><span class="p">])</span>
        <span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">CS</span><span class="p">)</span>
        <span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;f density [$cm^{-3}$]&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">RBBBS</span><span class="p">,</span> <span class="n">ZBBBS</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
        <span class="n">CS</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">Rgrid</span><span class="p">,</span> <span class="n">Zgrid</span><span class="p">,</span> <span class="n">RHOpRZ</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">,</span> <span class="mi">13</span><span class="p">),</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clabel</span><span class="p">(</span><span class="n">CS</span><span class="p">,</span> <span class="n">inline</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;R [m]&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Z [m]&#39;</span><span class="p">)</span>

    <span class="c1"># Get flux surface average quantities:</span>
    <span class="n">neut_fsa</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">rhop</span> <span class="o">=</span> <span class="n">neut_fsa</span><span class="p">[</span><span class="s1">&#39;rhop&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">geqdsk</span><span class="p">[</span><span class="s1">&#39;AuxQuantities&#39;</span><span class="p">][</span><span class="s1">&#39;RHOp&#39;</span><span class="p">]</span>
    <span class="n">neut_fsa</span><span class="p">[</span><span class="s1">&#39;names&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">names</span>

    <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="n">beams</span><span class="p">:</span>
        <span class="n">neut_fsa</span><span class="p">[</span><span class="n">beam</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">n_level</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]:</span>
            <span class="n">neut_fsa</span><span class="p">[</span><span class="n">beam</span><span class="p">][</span><span class="sa">f</span><span class="s1">&#39;n=</span><span class="si">{</span><span class="n">n_level</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">names</span><span class="p">):</span>
                <span class="n">dens</span> <span class="o">=</span> <span class="n">neutrals_ext</span><span class="p">[</span><span class="n">beam</span><span class="p">][</span><span class="sa">f</span><span class="s1">&#39;n=</span><span class="si">{</span><span class="n">n_level</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">][</span><span class="n">name</span><span class="p">]</span>

                <span class="c1"># flux surface average</span>
                <span class="k">def</span> <span class="nf">avg_function</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">RectBivariateSpline</span><span class="p">(</span><span class="n">Zgrid</span><span class="p">,</span> <span class="n">Rgrid</span><span class="p">,</span> <span class="n">dens</span><span class="p">,</span> <span class="n">kx</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ky</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">ev</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>

                <span class="n">neut_fsa</span><span class="p">[</span><span class="n">beam</span><span class="p">][</span><span class="sa">f</span><span class="s1">&#39;n=</span><span class="si">{</span><span class="n">n_level</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">][</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">geqdsk</span><span class="p">[</span><span class="s1">&#39;fluxSurfaces&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">surfAvg</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="n">avg_function</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="n">beams</span><span class="p">:</span>
        <span class="c1"># store beam component energies</span>
        <span class="n">neut_fsa</span><span class="p">[</span><span class="n">beam</span><span class="p">][</span><span class="s1">&#39;f_energy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">neutrals</span><span class="p">[</span><span class="n">beam</span><span class="p">][</span><span class="s1">&#39;f_energy&#39;</span><span class="p">]</span>  <span class="c1"># keV</span>
        <span class="n">neut_fsa</span><span class="p">[</span><span class="n">beam</span><span class="p">][</span><span class="s1">&#39;h_energy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">neutrals</span><span class="p">[</span><span class="n">beam</span><span class="p">][</span><span class="s1">&#39;h_energy&#39;</span><span class="p">]</span>  <span class="c1"># keV</span>
        <span class="n">neut_fsa</span><span class="p">[</span><span class="n">beam</span><span class="p">][</span><span class="s1">&#39;t_energy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">neutrals</span><span class="p">[</span><span class="n">beam</span><span class="p">][</span><span class="s1">&#39;t_energy&#39;</span><span class="p">]</span>  <span class="c1"># keV</span>
        <span class="n">neut_fsa</span><span class="p">[</span><span class="n">beam</span><span class="p">][</span><span class="s1">&#39;m_beam&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">neutrals</span><span class="p">[</span><span class="n">beam</span><span class="p">][</span><span class="s1">&#39;m_beam&#39;</span><span class="p">]</span>  <span class="c1"># amu</span>
    <span class="n">neut_fsa</span><span class="p">[</span><span class="s1">&#39;m_bckg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">neutrals</span><span class="p">[</span><span class="s1">&#39;m_bckg&#39;</span><span class="p">])</span>  <span class="c1"># amu</span>

    <span class="k">if</span> <span class="n">debug_plots</span><span class="p">:</span>
        <span class="n">ls_cycle</span> <span class="o">=</span> <span class="n">get_ls_cycle</span><span class="p">()</span>

        <span class="c1"># plot FSA neutral densities</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="n">forward</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">a1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">rowspan</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">colspan</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">a2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">rowspan</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">colspan</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="n">beams</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">n_level</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fdens&#39;</span><span class="p">,</span> <span class="s1">&#39;hdens&#39;</span><span class="p">,</span> <span class="s1">&#39;tdens&#39;</span><span class="p">,</span> <span class="s1">&#39;dcx+halo&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;dcx+halo&#39;</span><span class="p">:</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;halo&#39;</span>  <span class="c1"># simple renaming</span>
                    <span class="n">lss</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">ls_cycle</span><span class="p">)</span>
                    <span class="n">a1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rhop</span><span class="p">,</span> <span class="n">neut_fsa</span><span class="p">[</span><span class="n">beam</span><span class="p">][</span><span class="sa">f</span><span class="s1">&#39;n=</span><span class="si">{</span><span class="n">n_level</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">][</span><span class="n">name</span><span class="p">],</span> <span class="n">lss</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>
                    <span class="n">a2</span><span class="o">.</span><span class="n">plot</span><span class="p">([],</span> <span class="p">[],</span> <span class="n">lss</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">beam</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">, n=</span><span class="si">{</span><span class="n">n_level</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">a1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\rho_</span><span class="si">{p}</span><span class="s1">$&#39;</span><span class="p">)</span>
        <span class="n">a1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;FSA density&#39;</span><span class="p">)</span>
        <span class="n">a2</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
        <span class="n">a2</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="c1"># fig.tight_layout()</span>

    <span class="k">return</span> <span class="n">neut_fsa</span></div>


<div class="viewcode-block" id="get_ls_cycle"><a class="viewcode-back" href="../../aurora.html#aurora.nbi_neutrals.get_ls_cycle">[docs]</a><span class="k">def</span> <span class="nf">get_ls_cycle</span><span class="p">():</span>
    <span class="c1"># create useful list of plotting styles</span>
    <span class="n">color_vals</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;k&#39;</span><span class="p">]</span>
    <span class="n">style_vals</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="s1">&#39;-.&#39;</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">]</span>
    <span class="n">ls_vals</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">style_vals</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">color_vals</span><span class="p">:</span>
            <span class="n">ls_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span> <span class="o">+</span> <span class="n">s</span><span class="p">)</span>
            <span class="n">ls_cycle</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">cycle</span><span class="p">(</span><span class="n">ls_vals</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ls_cycle</span></div>


<div class="viewcode-block" id="get_NBI_imp_cxr_q"><a class="viewcode-back" href="../../aurora.html#aurora.nbi_neutrals.get_NBI_imp_cxr_q">[docs]</a><span class="k">def</span> <span class="nf">get_NBI_imp_cxr_q</span><span class="p">(</span><span class="n">neut_fsa</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">rhop_Ti</span><span class="p">,</span> <span class="n">times_Ti</span><span class="p">,</span> <span class="n">Ti_prof</span><span class="p">,</span> <span class="n">include_fast</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">include_halo</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">debug_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute flux-surface-averaged (FSA) charge exchange recombination for a given impurity with</span>
<span class="sd">    neutral beam components, applying appropriate Maxwellian averaging of cross sections and</span>
<span class="sd">    obtaining rates in [s^-1] units. This method expects all neutral components to be given in a</span>
<span class="sd">    dictionary with a structure that is independent of NBI model.</span>

<span class="sd">    Note that while Ti may be time-dependent, with a time base given by times_Ti, the FSA</span>
<span class="sd">    neutrals are expected to be time-independent. Hence, the resulting CXR rates will only have</span>
<span class="sd">    time dependence that reflects changes in Ti, but not the NBI.</span>

<span class="sd">    Args:</span>
<span class="sd">        neut_fsa : dict</span>
<span class="sd">             Dictionary containing FSA neutral densities in the form that is output by :py:meth:`get_neutrals_fsa`.</span>
<span class="sd">        q : int or float</span>
<span class="sd">             Charge of impurity species</span>
<span class="sd">        rhop_Ti : array-like</span>
<span class="sd">             Sqrt of poloidal flux radial coordinate for Ti profiles.</span>
<span class="sd">        times_Ti : array-like</span>
<span class="sd">             Time base on which Ti_prof is given [s]. </span>
<span class="sd">        Ti_prof : array-like</span>
<span class="sd">             Ion temperature profile on the rhop_Ti, times_Ti bases.</span>
<span class="sd">        include_fast : bool, optional</span>
<span class="sd">             If True, include CXR rates from fast NBI neutrals. Default is True. </span>
<span class="sd">        include_halo : bool, optional</span>
<span class="sd">             If True, include CXR rates from themral NBI halo neutrals. Default is True. </span>
<span class="sd">        debug_plots : bool, optional</span>
<span class="sd">             If True, plot several plots to assess the quality of the calculation. </span>

<span class="sd">    Returns:</span>
<span class="sd">        rates : dict</span>
<span class="sd">            Dictionary containing CXR rates from NBI neutrals. This dictionary has analogous form to the </span>
<span class="sd">            :py:meth:`get_neutrals_fsa` function, e.g. we have </span>

<span class="sd">            .. code-block:: python</span>

<span class="sd">                rates[beam][f&#39;n={n_level}&#39;][&#39;halo&#39;]</span>

<span class="sd">            Rates are on a radial grid corresponding to the input neut_fsa[&#39;rhop&#39;]. </span>

<span class="sd">    For details on inputs and outputs, it is recommendeded to look at the internal plotting functions. </span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">m_bckg</span> <span class="o">=</span> <span class="n">neut_fsa</span><span class="p">[</span><span class="s1">&#39;m_bckg&#39;</span><span class="p">]</span>  <span class="c1"># amu</span>
    <span class="n">rhop</span> <span class="o">=</span> <span class="n">neut_fsa</span><span class="p">[</span><span class="s1">&#39;rhop&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">times_Ti</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">Ti</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">interp1d</span><span class="p">(</span><span class="n">rhop_Ti</span><span class="p">,</span> <span class="n">Ti_prof</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1e3</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mf">3e-3</span><span class="p">)(</span><span class="n">rhop</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>  <span class="c1"># keV</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Ti</span> <span class="o">=</span> <span class="n">RectBivariateSpline</span><span class="p">(</span><span class="n">times_Ti</span><span class="p">,</span> <span class="n">rhop_Ti</span><span class="p">,</span> <span class="n">Ti_prof</span> <span class="o">/</span> <span class="mf">1e3</span><span class="p">)(</span><span class="n">times_Ti</span><span class="p">,</span> <span class="n">rhop</span><span class="p">)</span>  <span class="c1"># keV</span>

    <span class="c1"># collect rates for each energy component and excited state (ONLY fast neutrals here)</span>
    <span class="n">rates</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">rates</span><span class="p">[</span><span class="s1">&#39;rhop&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rhop</span>
    <span class="n">rates</span><span class="p">[</span><span class="s1">&#39;times&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">times_Ti</span>
    <span class="n">rates</span><span class="p">[</span><span class="s1">&#39;cxr_total&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">rhop</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">times_Ti</span><span class="p">)))</span>

    <span class="c1"># setup dictionaries here in case include_fast=False</span>
    <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="n">beams</span><span class="p">:</span>
        <span class="n">rates</span><span class="p">[</span><span class="n">beam</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">rates</span><span class="p">[</span><span class="n">beam</span><span class="p">][</span><span class="s1">&#39;cxr_total&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">rhop</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">times_Ti</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">n_level</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]:</span>
            <span class="n">rates</span><span class="p">[</span><span class="n">beam</span><span class="p">][</span><span class="sa">f</span><span class="s1">&#39;n=</span><span class="si">{</span><span class="n">n_level</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="n">include_fast</span><span class="p">:</span>
        <span class="c1"># compute impurity recombination rate with fast neutral populations</span>
        <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="n">beams</span><span class="p">:</span>
            <span class="n">m_beam</span> <span class="o">=</span> <span class="n">neut_fsa</span><span class="p">[</span><span class="n">beam</span><span class="p">][</span><span class="s1">&#39;m_beam&#39;</span><span class="p">]</span>  <span class="c1"># amu</span>
            <span class="k">for</span> <span class="n">n_level</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">]:</span>
                    <span class="n">rates</span><span class="p">[</span><span class="n">beam</span><span class="p">][</span><span class="sa">f</span><span class="s1">&#39;n=</span><span class="si">{</span><span class="n">n_level</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">][</span><span class="n">comp</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

                    <span class="c1"># energy of each beam component</span>
                    <span class="n">energy</span> <span class="o">=</span> <span class="n">neut_fsa</span><span class="p">[</span><span class="n">beam</span><span class="p">][</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">comp</span><span class="si">}</span><span class="s1">_energy&#39;</span><span class="p">]</span>  <span class="c1"># keV</span>

                    <span class="c1"># create cross section function only as a function of energy/amu for Maxwellian average</span>
                    <span class="n">sigma_fun</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">E_per_amu</span><span class="p">:</span> <span class="n">js_sigma</span><span class="p">(</span><span class="n">E_per_amu</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">n1</span><span class="o">=</span><span class="n">n_level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;cx&#39;</span><span class="p">)</span>  <span class="c1"># cm^2</span>

                    <span class="n">rate</span> <span class="o">=</span> <span class="n">bt_rate_maxwell_average</span><span class="p">(</span><span class="n">sigma_fun</span><span class="p">,</span> <span class="n">Ti</span><span class="p">,</span> <span class="n">energy</span><span class="p">,</span> <span class="n">m_bckg</span><span class="p">,</span> <span class="n">m_beam</span><span class="p">,</span> <span class="n">n_level</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span>  <span class="c1"># .T</span>
                    <span class="n">rates</span><span class="p">[</span><span class="n">beam</span><span class="p">][</span><span class="sa">f</span><span class="s1">&#39;n=</span><span class="si">{</span><span class="n">n_level</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">][</span><span class="n">comp</span><span class="p">]</span> <span class="o">=</span> <span class="n">rate</span> <span class="o">*</span> <span class="n">neut_fsa</span><span class="p">[</span><span class="n">beam</span><span class="p">][</span><span class="sa">f</span><span class="s1">&#39;n=</span><span class="si">{</span><span class="n">n_level</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">][</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">comp</span><span class="si">}</span><span class="s1">dens&#39;</span><span class="p">][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>

                    <span class="c1"># we are eventually interested in the total:</span>
                    <span class="n">rates</span><span class="p">[</span><span class="n">beam</span><span class="p">][</span><span class="s1">&#39;cxr_total&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">rates</span><span class="p">[</span><span class="n">beam</span><span class="p">][</span><span class="sa">f</span><span class="s1">&#39;n=</span><span class="si">{</span><span class="n">n_level</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">][</span><span class="n">comp</span><span class="p">]</span>

            <span class="c1"># sum over all beams:</span>
            <span class="n">rates</span><span class="p">[</span><span class="s1">&#39;cxr_total&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">rates</span><span class="p">[</span><span class="n">beam</span><span class="p">][</span><span class="s1">&#39;cxr_total&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">include_halo</span><span class="p">:</span>
        <span class="c1"># Now add recombination from halo neutrals (all thermal interactions) - n-unresolved for impurities</span>
        <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="n">beams</span><span class="p">:</span>
            <span class="n">m_beam</span> <span class="o">=</span> <span class="n">neut_fsa</span><span class="p">[</span><span class="n">beam</span><span class="p">][</span><span class="s1">&#39;m_beam&#39;</span><span class="p">]</span>  <span class="c1"># amu</span>

            <span class="k">for</span> <span class="n">n_level</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]:</span>
                <span class="c1"># use Janev &amp; Smith rates for halos too...</span>
                <span class="n">sigma_fun</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">E_per_amu</span><span class="p">:</span> <span class="n">js_sigma</span><span class="p">(</span><span class="n">E_per_amu</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">n1</span><span class="o">=</span><span class="n">n_level</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;cx&#39;</span><span class="p">)</span>  <span class="c1"># cm^2</span>

                <span class="c1"># Maxwell average using a &quot;beam&quot; at thermal energy (WRONG)</span>
                <span class="c1"># rate1 = bt_rate_maxwell_average(sigma_fun, Ti, Ti, m_bckg, m_beam, n_level + 1.0)</span>

                <span class="c1"># use proper thermal-thermal averaging</span>
                <span class="c1"># the following function at the moment can only take time-independent Ti!</span>
                <span class="n">rate</span> <span class="o">=</span> <span class="n">tt_rate_maxwell_average</span><span class="p">(</span><span class="n">sigma_fun</span><span class="p">,</span> <span class="n">Ti</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">m_bckg</span><span class="p">,</span> <span class="n">m_beam</span><span class="p">,</span> <span class="n">n_level</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span>

                <span class="c1"># plt.figure()</span>
                <span class="c1"># plt.plot(rhop, rate1, label=&#39;bt&#39;)</span>
                <span class="c1"># plt.plot(rhop, rate, label=&#39;tt&#39;)</span>
                <span class="c1"># plt.xlabel(r&#39;$\rho_p$&#39;)</span>
                <span class="c1"># plt.legend()</span>

                <span class="n">rates</span><span class="p">[</span><span class="n">beam</span><span class="p">][</span><span class="sa">f</span><span class="s1">&#39;n=</span><span class="si">{</span><span class="n">n_level</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">][</span><span class="s1">&#39;halo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rate</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">neut_fsa</span><span class="p">[</span><span class="n">beam</span><span class="p">][</span><span class="sa">f</span><span class="s1">&#39;n=</span><span class="si">{</span><span class="n">n_level</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">][</span><span class="s1">&#39;dcx+halo&#39;</span><span class="p">][:,</span> <span class="kc">None</span><span class="p">]</span>
                <span class="n">rates</span><span class="p">[</span><span class="n">beam</span><span class="p">][</span><span class="s1">&#39;cxr_total&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">rates</span><span class="p">[</span><span class="n">beam</span><span class="p">][</span><span class="sa">f</span><span class="s1">&#39;n=</span><span class="si">{</span><span class="n">n_level</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">][</span><span class="s1">&#39;halo&#39;</span><span class="p">]</span>
                <span class="n">rates</span><span class="p">[</span><span class="s1">&#39;cxr_total&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">rates</span><span class="p">[</span><span class="n">beam</span><span class="p">][</span><span class="sa">f</span><span class="s1">&#39;n=</span><span class="si">{</span><span class="n">n_level</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">][</span><span class="s1">&#39;halo&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">debug_plots</span><span class="p">:</span>
        <span class="n">ls_cycle</span> <span class="o">=</span> <span class="n">get_ls_cycle</span><span class="p">()</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="n">forward</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">a1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">rowspan</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">colspan</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">a2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">rowspan</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">colspan</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="n">beams</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">n_level</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">include_fast</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">]:</span>
                        <span class="c1"># time average to reduce number of lines</span>
                        <span class="n">lss</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">ls_cycle</span><span class="p">)</span>
                        <span class="n">a1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rhop</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rates</span><span class="p">[</span><span class="n">beam</span><span class="p">][</span><span class="sa">f</span><span class="s1">&#39;n=</span><span class="si">{</span><span class="n">n_level</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">][</span><span class="n">comp</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span> <span class="n">lss</span><span class="p">)</span>
                        <span class="n">a2</span><span class="o">.</span><span class="n">plot</span><span class="p">([],</span> <span class="p">[],</span> <span class="n">lss</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">beam</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">comp</span><span class="si">}</span><span class="s1">-energy, n=</span><span class="si">{</span><span class="n">n_level</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">include_halo</span><span class="p">:</span>
                    <span class="n">lss</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">ls_cycle</span><span class="p">)</span>
                    <span class="n">a1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rhop</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rates</span><span class="p">[</span><span class="n">beam</span><span class="p">][</span><span class="sa">f</span><span class="s1">&#39;n=</span><span class="si">{</span><span class="n">n_level</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">][</span><span class="s1">&#39;halo&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span> <span class="n">lss</span><span class="p">)</span>
                    <span class="n">a2</span><span class="o">.</span><span class="n">plot</span><span class="p">([],</span> <span class="p">[],</span> <span class="n">lss</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">beam</span><span class="si">}</span><span class="s1"> halo, n=</span><span class="si">{</span><span class="n">n_level</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="n">a1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rhop</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rates</span><span class="p">[</span><span class="n">beam</span><span class="p">][</span><span class="s1">&#39;cxr_total&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;beam </span><span class="si">{</span><span class="n">beam</span><span class="si">}</span><span class="s1"> CXR total&#39;</span><span class="p">)</span>
            <span class="n">a2</span><span class="o">.</span><span class="n">plot</span><span class="p">([],</span> <span class="p">[],</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;beam </span><span class="si">{</span><span class="n">beam</span><span class="si">}</span><span class="s1"> CXR total&#39;</span><span class="p">)</span>

        <span class="n">a1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rhop</span><span class="p">,</span> <span class="n">rates</span><span class="p">[</span><span class="s1">&#39;cxr_total&#39;</span><span class="p">])</span>
        <span class="n">a2</span><span class="o">.</span><span class="n">plot</span><span class="p">([],</span> <span class="p">[],</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;CXR total&#39;</span><span class="p">)</span>
        <span class="n">a1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\rho_p$&#39;</span><span class="p">)</span>
        <span class="n">a1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">fr</span><span class="s1">&#39;CXR rate (q=</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s1">) [$s^</span><span class="si">{</span><span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">}</span><span class="si">}</span><span class="s1">$]&#39;</span><span class="p">)</span>
        <span class="n">a2</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="n">a2</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">rates</span></div>


<div class="viewcode-block" id="beam_grid"><a class="viewcode-back" href="../../aurora.html#aurora.nbi_neutrals.beam_grid">[docs]</a><span class="k">def</span> <span class="nf">beam_grid</span><span class="p">(</span><span class="n">uvw_src</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">max_radius</span><span class="o">=</span><span class="mf">255.0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Method to obtain the 3D orientation of a beam with respect to the device.</span>
<span class="sd">    The uvw_src and (normalized) axis arrays may be obtained from the d3d_beams method</span>
<span class="sd">    of fidasim_lib.py in the FIDASIM module in OMFIT. </span>

<span class="sd">    This is inspired by `beam_grid` in fidasim_lib.py of the FIDASIM module (S. Haskey) </span>
<span class="sd">    in OMFIT. </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">pos</span> <span class="o">=</span> <span class="n">uvw_src</span> <span class="o">+</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">axis</span>
    <span class="n">rsrc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">uvw_src</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">uvw_src</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rsrc</span> <span class="o">&lt;</span> <span class="n">max_radius</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Source radius:</span><span class="si">{}</span><span class="s2"> cannot be less then max_radius:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rsrc</span><span class="p">,</span> <span class="n">max_radius</span><span class="p">))</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">()</span>
    <span class="n">dis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">uvw_src</span> <span class="o">-</span> <span class="n">pos</span><span class="p">)</span> <span class="o">**</span> <span class="mf">2.0</span><span class="p">))</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">((</span><span class="n">uvw_src</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="n">dis</span><span class="p">)</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">((</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">uvw_src</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">uvw_src</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">gamma</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="c1"># Find where the origin has to be along the beam injection</span>
    <span class="c1"># axis so that x=0 is at a radius of max_radius</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">axis</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">axis</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="n">b</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">uvw_src</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">axis</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">uvw_src</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">axis</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">uvw_src</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">uvw_src</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">max_radius</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">b</span> <span class="o">-</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">b</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">a</span> <span class="o">*</span> <span class="n">c</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">a</span><span class="p">)</span>
    <span class="n">origin</span> <span class="o">=</span> <span class="n">uvw_src</span> <span class="o">+</span> <span class="n">t</span> <span class="o">*</span> <span class="n">axis</span>
    <span class="k">return</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">origin</span></div>


<div class="viewcode-block" id="rotation_matrix"><a class="viewcode-back" href="../../aurora.html#aurora.nbi_neutrals.rotation_matrix">[docs]</a><span class="k">def</span> <span class="nf">rotation_matrix</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;See the table of all rotation possiblities, on the Tait Bryan side</span>
<span class="sd">    https://en.wikipedia.org/wiki/Euler_angles#Tait.E2.80.93Bryan_angles</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">alpha</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">beta</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">gamma</span>
    <span class="n">sa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">ca</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">sb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="n">cb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="n">sg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
    <span class="n">cg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ca</span> <span class="o">*</span> <span class="n">cb</span>
    <span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ca</span> <span class="o">*</span> <span class="n">sb</span> <span class="o">*</span> <span class="n">sg</span> <span class="o">-</span> <span class="n">cg</span> <span class="o">*</span> <span class="n">sa</span>
    <span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">sa</span> <span class="o">*</span> <span class="n">sg</span> <span class="o">+</span> <span class="n">ca</span> <span class="o">*</span> <span class="n">cg</span> <span class="o">*</span> <span class="n">sb</span>
    <span class="n">R</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cb</span> <span class="o">*</span> <span class="n">sa</span>
    <span class="n">R</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ca</span> <span class="o">*</span> <span class="n">cg</span> <span class="o">+</span> <span class="n">sa</span> <span class="o">*</span> <span class="n">sb</span> <span class="o">*</span> <span class="n">sg</span>
    <span class="n">R</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cg</span> <span class="o">*</span> <span class="n">sa</span> <span class="o">*</span> <span class="n">sb</span> <span class="o">-</span> <span class="n">ca</span> <span class="o">*</span> <span class="n">sg</span>
    <span class="n">R</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">sb</span>
    <span class="n">R</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cb</span> <span class="o">*</span> <span class="n">sg</span>
    <span class="n">R</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cb</span> <span class="o">*</span> <span class="n">cg</span>
    
    <span class="k">return</span> <span class="n">R</span></div>


<div class="viewcode-block" id="uvw_xyz"><a class="viewcode-back" href="../../aurora.html#aurora.nbi_neutrals.uvw_xyz">[docs]</a><span class="k">def</span> <span class="nf">uvw_xyz</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">R</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes array elements by multiplying the rows of the first</span>
<span class="sd">    array by the columns of the second array. The second array</span>
<span class="sd">    must have the same number of rows as the first array has</span>
<span class="sd">    columns. The resulting array has the same number of rows as</span>
<span class="sd">    the first array and the same number of columns as the second</span>
<span class="sd">    array.</span>
<span class="sd">    </span>
<span class="sd">    See uvw_to_xyz in fidasim.f90</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
    <span class="n">orig_shape</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">order</span> <span class="o">=</span> <span class="s1">&#39;C&#39;</span>
    <span class="n">uvw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">u</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">),</span> <span class="n">v</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">),</span> <span class="n">w</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)]))</span>
    <span class="n">uvw_shifted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">uvw</span> <span class="o">-</span> <span class="n">origin</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:])</span>
    <span class="n">basis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>

    <span class="n">xyz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">uvw_shifted</span><span class="p">)</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">orig_shape</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">),</span> <span class="n">xyz</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">orig_shape</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">),</span> <span class="n">xyz</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">orig_shape</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span></div>


<div class="viewcode-block" id="xyz_uvw"><a class="viewcode-back" href="../../aurora.html#aurora.nbi_neutrals.xyz_uvw">[docs]</a><span class="k">def</span> <span class="nf">xyz_uvw</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">R</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes array elements by multiplying the rows of the first</span>
<span class="sd">    array by the columns of the second array. The second array</span>
<span class="sd">    must have the same number of rows as the first array has</span>
<span class="sd">    columns. The resulting array has the same number of rows as</span>
<span class="sd">    the first array and the same number of columns as the second</span>
<span class="sd">    array.</span>
<span class="sd">    </span>
<span class="sd">    See xyz_to_uvw in fidasim.f90</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
    <span class="n">orig_shape</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">order</span> <span class="o">=</span> <span class="s1">&#39;C&#39;</span>
    <span class="n">xyz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">),</span> <span class="n">y</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">),</span> <span class="n">z</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)])</span>

    <span class="n">basis</span> <span class="o">=</span> <span class="n">R</span>

    <span class="n">uvw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">xyz</span><span class="p">)</span> <span class="o">+</span> <span class="n">origin</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">uvw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">orig_shape</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">),</span> <span class="n">uvw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">orig_shape</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">),</span> <span class="n">uvw</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">orig_shape</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">w</span></div>








<div class="viewcode-block" id="bt_rate_maxwell_average"><a class="viewcode-back" href="../../aurora.html#aurora.nbi_neutrals.bt_rate_maxwell_average">[docs]</a><span class="k">def</span> <span class="nf">bt_rate_maxwell_average</span><span class="p">(</span><span class="n">sigma_fun</span><span class="p">,</span> <span class="n">Ti</span><span class="p">,</span> <span class="n">E_beam</span><span class="p">,</span> <span class="n">m_bckg</span><span class="p">,</span> <span class="n">m_beam</span><span class="p">,</span> <span class="n">n_level</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculates Maxwellian reaction rate for a beam with atomic mass &quot;m_beam&quot;, </span>
<span class="sd">    energy &quot;E_beam&quot;, firing into a target with atomic mass &quot;m_bckg&quot; and temperature &quot;T&quot;.</span>

<span class="sd">    The &quot;sigma_fun&quot; argument must be a function for a specific charge and n-level of the beam particles.</span>
<span class="sd">    Ref: FIDASIM atomic_tables.f90 bt_maxwellian_n_m.</span>

<span class="sd">    Args:</span>
<span class="sd">        sigma_fun: :py:meth</span>
<span class="sd">            Function to compute a specific cross section [cm^2], function of energy/amu ONLY.</span>
<span class="sd">            Expected call form: sigma_fun(erel/ared)</span>
<span class="sd">        Ti : float, 1D or 2D array</span>
<span class="sd">            Target temperature [keV]. Results will be computed for each Ti value in a vectorized manner.</span>
<span class="sd">        E_beam : float</span>
<span class="sd">            Beam energy [keV]</span>
<span class="sd">        m_bckg : float</span>
<span class="sd">            Target atomic mass [amu]</span>
<span class="sd">        m_beam : float</span>
<span class="sd">            Beam atomic mass [amu]</span>
<span class="sd">        n_level :int</span>
<span class="sd">            n-level of beam. This is used to evaluate the hydrogen ionization potential,</span>
<span class="sd">            below which an electron is unlikely to charge exchange with surrounding ions.</span>

<span class="sd">    Returns:</span>
<span class="sd">        rate : output reaction rate in [cm^3/s] units</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">constants</span> <span class="k">as</span> <span class="n">consts</span>

    <span class="c1"># enforce expected shape</span>
    <span class="n">Ti</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">Ti</span><span class="p">)</span>

    <span class="c1"># radial and parallel velocity grids, in units of thermal velocity</span>
    <span class="n">vr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
    <span class="n">vz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>

    <span class="c1"># normalized energy and temperature</span>
    <span class="n">E_beam_per_amu</span> <span class="o">=</span> <span class="n">E_beam</span> <span class="o">/</span> <span class="n">m_beam</span>  <span class="c1"># E_bar</span>
    <span class="n">T_per_amu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">Ti</span><span class="p">,</span> <span class="mf">1.0e-6</span><span class="p">)</span> <span class="o">/</span> <span class="n">m_bckg</span>  <span class="c1"># T_bar</span>

    <span class="c1"># beam/target reduced mass:</span>
    <span class="n">ared</span> <span class="o">=</span> <span class="n">m_bckg</span> <span class="o">*</span> <span class="n">m_beam</span> <span class="o">/</span> <span class="p">(</span><span class="n">m_bckg</span> <span class="o">+</span> <span class="n">m_beam</span><span class="p">)</span>
    <span class="n">dE</span> <span class="o">=</span> <span class="p">(</span><span class="mf">13.6e-3</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">n_level</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># hydrogen ionization potential</span>

    <span class="n">v_therm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">T_per_amu</span> <span class="o">*</span> <span class="mf">1.0e3</span> <span class="o">*</span> <span class="n">consts</span><span class="o">.</span><span class="n">e</span> <span class="o">/</span> <span class="n">consts</span><span class="o">.</span><span class="n">m_p</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e2</span>

    <span class="n">zb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">E_beam_per_amu</span> <span class="o">/</span> <span class="n">T_per_amu</span><span class="p">)</span>  <span class="c1"># sqrt(E_bar/T_bar)</span>
    <span class="n">u2_to_erel</span> <span class="o">=</span> <span class="n">ared</span> <span class="o">*</span> <span class="n">T_per_amu</span>

    <span class="k">if</span> <span class="n">ared</span> <span class="o">&lt;=</span> <span class="mf">0.5</span><span class="p">:</span>  <span class="c1"># for electron interactions</span>
        <span class="n">ared</span> <span class="o">=</span> <span class="mf">1.0</span>

    <span class="n">fr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Ti</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Ti</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">vr</span><span class="p">)))</span>
    <span class="n">fz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Ti</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Ti</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">vz</span><span class="p">)))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vz</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vr</span><span class="p">)):</span>
            <span class="c1"># relative square velocity:</span>
            <span class="n">u2</span> <span class="o">=</span> <span class="p">(</span><span class="n">zb</span> <span class="o">-</span> <span class="n">vz</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">vr</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="n">Erel</span> <span class="o">=</span> <span class="n">u2_to_erel</span> <span class="o">*</span> <span class="n">u2</span>

            <span class="n">sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">Erel</span><span class="p">)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">Erel</span> <span class="o">&gt;=</span> <span class="n">dE</span>  <span class="c1"># no possible interaction below hydrogen ionization potential</span>
            <span class="n">sig</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">sigma_fun</span><span class="p">(</span><span class="n">Erel</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">/</span> <span class="n">ared</span><span class="p">)</span>

            <span class="n">fr</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">sig</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">u2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">vz</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">**</span> <span class="mf">2.0</span> <span class="o">+</span> <span class="n">vr</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">**</span> <span class="mf">2.0</span><span class="p">))</span> <span class="o">*</span> <span class="n">vr</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>

        <span class="n">fz</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">integrate</span><span class="o">.</span><span class="n">simps</span><span class="p">(</span><span class="n">fr</span><span class="p">,</span> <span class="n">vr</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># effective maxwellian-averaged rate:</span>
    <span class="n">sig_eff</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span> <span class="o">*</span> <span class="n">scipy</span><span class="o">.</span><span class="n">integrate</span><span class="o">.</span><span class="n">simps</span><span class="p">(</span><span class="n">fz</span><span class="p">,</span> <span class="n">vz</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">rate</span> <span class="o">=</span> <span class="n">sig_eff</span> <span class="o">*</span> <span class="n">v_therm</span>

    <span class="k">return</span> <span class="n">rate</span></div>


<div class="viewcode-block" id="bt_rate_maxwell_average_vec"><a class="viewcode-back" href="../../aurora.html#aurora.nbi_neutrals.bt_rate_maxwell_average_vec">[docs]</a><span class="k">def</span> <span class="nf">bt_rate_maxwell_average_vec</span><span class="p">(</span><span class="n">sigma_fun</span><span class="p">,</span> <span class="n">Ti</span><span class="p">,</span> <span class="n">E_beam</span><span class="p">,</span> <span class="n">m_bckg</span><span class="p">,</span> <span class="n">m_beam</span><span class="p">,</span> <span class="n">n_level</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculates Maxwellian reaction rate for a beam with atomic mass &quot;m_beam&quot;, </span>
<span class="sd">    energy &quot;E_beam&quot;, firing into a target with atomic mass &quot;m_bckg&quot; and temperature &quot;T&quot;.</span>

<span class="sd">    The &quot;sigma_fun&quot; argument must be a function for a specific charge and n-level of the beam particles.</span>
<span class="sd">    Ref: FIDASIM atomic_tables.f90 bt_maxwellian_n_m.</span>

<span class="sd">    This version of the function attempts to vectorize the calculation such that we can have Ti</span>
<span class="sd">    being a function of space and time and deal with integrations in vr and vz with no loops.</span>

<span class="sd">    Args:</span>
<span class="sd">        sigma_fun: :py:meth</span>
<span class="sd">            Function to compute a specific cross section [cm^2], function of energy/amu ONLY.</span>
<span class="sd">            Expected call form: sigma_fun(erel/ared)</span>
<span class="sd">        Ti : float, 1D or 2D array</span>
<span class="sd">            Target temperature [keV]</span>
<span class="sd">        E_beam : float</span>
<span class="sd">            Beam energy [keV]</span>
<span class="sd">        m_bckg : float</span>
<span class="sd">            Target atomic mass [amu]</span>
<span class="sd">        m_beam : float</span>
<span class="sd">            Beam atomic mass [amu]</span>
<span class="sd">        n_level : int</span>
<span class="sd">            n-level of beam. This is used to evaluate the hydrogen ionization potential,</span>
<span class="sd">            below which an electron is unlikely to charge exchange with surrounding ions.</span>

<span class="sd">    Returns:</span>
<span class="sd">        rate : output reaction rate in [cm^3/s] units</span>

<span class="sd">    ~~~~~~~~~~ UNTESTED!~~~~~~~~~~~</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">constants</span> <span class="k">as</span> <span class="n">consts</span>
    <span class="kn">from</span> <span class="nn">scipy.integrate</span> <span class="kn">import</span> <span class="n">simps</span>

    <span class="c1"># radial and parallel velocity grids, in units of thermal velocity</span>
    <span class="n">vr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
    <span class="n">vz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>

    <span class="c1"># normalized energy and temperature</span>
    <span class="n">E_beam_per_amu</span> <span class="o">=</span> <span class="n">E_beam</span> <span class="o">/</span> <span class="n">m_beam</span>  <span class="c1"># E_bar</span>
    <span class="n">T_per_amu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">Ti</span><span class="p">,</span> <span class="mf">1.0e-6</span><span class="p">)</span> <span class="o">/</span> <span class="n">m_bckg</span>  <span class="c1"># T_bar</span>

    <span class="c1"># beam/target reduced mass:</span>
    <span class="n">ared</span> <span class="o">=</span> <span class="n">m_bckg</span> <span class="o">*</span> <span class="n">m_beam</span> <span class="o">/</span> <span class="p">(</span><span class="n">m_bckg</span> <span class="o">+</span> <span class="n">m_beam</span><span class="p">)</span>
    <span class="n">dE</span> <span class="o">=</span> <span class="p">(</span><span class="mf">13.6e-3</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">n_level</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># hydrogen ionization potential</span>

    <span class="n">v_therm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">T_per_amu</span> <span class="o">*</span> <span class="mf">1.0e3</span> <span class="o">*</span> <span class="n">consts</span><span class="o">.</span><span class="n">e</span> <span class="o">/</span> <span class="n">consts</span><span class="o">.</span><span class="n">m_p</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e2</span>

    <span class="n">zb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">E_beam_per_amu</span> <span class="o">/</span> <span class="n">T_per_amu</span><span class="p">)</span>  <span class="c1"># sqrt(E_bar/T_bar)</span>

    <span class="n">sig_4d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Ti</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Ti</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">vz</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">vr</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="c1"># relative square velocity:</span>
    <span class="n">u2</span> <span class="o">=</span> <span class="p">(</span><span class="n">zb</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">-</span> <span class="n">vz</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">vr</span><span class="p">[</span>
        <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">j</span>
    <span class="p">]</span> <span class="o">**</span> <span class="mi">2</span>

    <span class="n">Erel</span> <span class="o">=</span> <span class="n">ared</span> <span class="o">*</span> <span class="n">T_per_amu</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">u2</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">Erel</span> <span class="o">&gt;=</span> <span class="n">dE</span>  <span class="c1"># no possible interaction below hydrogen ionization potential</span>

    <span class="n">Ebar</span> <span class="o">=</span> <span class="n">Erel</span> <span class="o">/</span> <span class="n">ared</span> <span class="k">if</span> <span class="n">ared</span> <span class="o">&gt;</span> <span class="mf">0.5</span> <span class="k">else</span> <span class="n">Erel</span>

    <span class="n">sig_2d</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">sigma_fun</span><span class="p">(</span><span class="n">erel</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">/</span> <span class="n">ared</span><span class="p">)</span>

    <span class="n">integ_term</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">sig_2d</span>
        <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">u2</span><span class="p">)</span>
        <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">vz</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">vr</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span> <span class="o">**</span> <span class="mf">2.0</span><span class="p">))</span>
        <span class="o">*</span> <span class="n">vr</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>
    <span class="p">)</span>

    <span class="c1"># effective maxwellian-averaged rate:</span>
    <span class="n">sig_eff</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span> <span class="o">*</span> <span class="n">simps</span><span class="p">(</span><span class="n">simps</span><span class="p">(</span><span class="n">integ_term</span><span class="p">,</span> <span class="n">vr</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span> <span class="n">vz</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">rate</span> <span class="o">=</span> <span class="n">sig_eff</span> <span class="o">*</span> <span class="n">v_therm</span>

    <span class="k">return</span> <span class="n">rate</span></div>


<div class="viewcode-block" id="tt_rate_maxwell_average"><a class="viewcode-back" href="../../aurora.html#aurora.nbi_neutrals.tt_rate_maxwell_average">[docs]</a><span class="k">def</span> <span class="nf">tt_rate_maxwell_average</span><span class="p">(</span><span class="n">sigma_fun</span><span class="p">,</span> <span class="n">Ti</span><span class="p">,</span> <span class="n">m_i</span><span class="p">,</span> <span class="n">m_n</span><span class="p">,</span> <span class="n">n_level</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculates Maxwellian reaction rate for an interaction between two thermal populations,</span>
<span class="sd">    assumed to be of neutrals (mass m_n) and background ions (mass m_i).</span>

<span class="sd">    The &#39;sigma_fun&#39; argument must be a function for a specific charge and n-level of the neutral </span>
<span class="sd">    particles. This allows evaluation of atomic rates for charge exchange interactions between thermal</span>
<span class="sd">    beam halos and background ions.</span>

<span class="sd">    Args:</span>
<span class="sd">        sigma_fun: python function</span>
<span class="sd">            Function to compute a specific cross section [cm^2], function of energy/amu ONLY.</span>
<span class="sd">            Expected call form: sigma_fun(erel/ared)</span>
<span class="sd">        Ti: float or 1D array</span>
<span class="sd">            background ion and halo temperature [keV]</span>
<span class="sd">        m_i: float</span>
<span class="sd">            mass of background ions [amu]</span>
<span class="sd">        m_n: float </span>
<span class="sd">            mass of neutrals [amu]</span>
<span class="sd">        n_level: int</span>
<span class="sd">            n-level of beam. This is used to evaluate the hydrogen ionization potential,</span>
<span class="sd">            below which an electron is unlikely to charge exchange with surrounding ions.</span>

<span class="sd">        TODO: add effect of toroidal rotation! This will require making the integration in this</span>
<span class="sd">        function 2-dimensional.</span>

<span class="sd">    Returns:</span>
<span class="sd">        rate : float or 1D array</span>
<span class="sd">            output reaction rate in [cm^3/s] units</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Ti</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">Ti</span><span class="p">)</span>

    <span class="n">vz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
    <span class="n">Erel</span> <span class="o">=</span> <span class="n">Ti</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">vz</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span> <span class="o">**</span> <span class="mi">2</span>

    <span class="c1"># normalized energy and temperature</span>
    <span class="n">T_per_amu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">Ti</span><span class="p">,</span> <span class="mf">1.0e-6</span><span class="p">)</span> <span class="o">/</span> <span class="n">m_n</span>  <span class="c1"># T_bar</span>

    <span class="n">integrand</span> <span class="o">=</span> <span class="p">(</span>
        <span class="k">lambda</span> <span class="n">erel</span><span class="p">:</span> <span class="n">bt_rate_maxwell_average</span><span class="p">(</span><span class="n">sigma_fun</span><span class="p">,</span> <span class="n">Ti</span><span class="p">,</span> <span class="n">erel</span><span class="p">,</span> <span class="n">m_i</span><span class="p">,</span> <span class="n">m_n</span><span class="p">,</span> <span class="n">n_level</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">m_n</span> <span class="o">*</span> <span class="n">erel</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">erel</span> <span class="o">/</span> <span class="n">Ti</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">dE</span> <span class="o">=</span> <span class="p">(</span><span class="mf">13.6e-3</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">n_level</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># hydrogen ionization potential</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">Erel</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">ie</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vz</span><span class="p">)):</span>  <span class="c1"># loop over vz</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">Erel</span><span class="p">[:,</span> <span class="n">ie</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">dE</span>  <span class="c1"># no possible interaction below hydrogen ionization potential</span>
        <span class="n">sigma</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="n">ie</span><span class="p">]</span> <span class="o">=</span> <span class="n">bt_rate_maxwell_average</span><span class="p">(</span><span class="n">sigma_fun</span><span class="p">,</span> <span class="n">Ti</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">Erel</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="n">ie</span><span class="p">],</span> <span class="n">m_i</span><span class="p">,</span> <span class="n">m_n</span><span class="p">,</span> <span class="n">n_level</span><span class="p">)</span>

    <span class="n">prefactor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">T_per_amu</span><span class="p">))</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">sigmav</span> <span class="o">=</span> <span class="n">prefactor</span> <span class="o">*</span> <span class="n">scipy</span><span class="o">.</span><span class="n">integrate</span><span class="o">.</span><span class="n">simps</span><span class="p">(</span><span class="n">sigma</span><span class="p">,</span> <span class="n">Erel</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">sigmav</span></div>

</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, F.Sciortino

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>