

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>aurora.radiation &mdash; Aurora 1.0.0 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> Aurora
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
    
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../requirements.html">Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../params.html">Input parameters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../atomic_data.html">Atomic data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../citing.html">Citing Aurora</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contacts.html">Questions and contributions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aurora.html">Aurora modules</a></li>
</ul>

            
          
    <a href="genindex.html">Index</a>
  
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Aurora</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>aurora.radiation</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for aurora.radiation</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span><span class="o">,</span><span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">interp1d</span>
<span class="kn">from</span> <span class="nn">omfit_commonclasses.utils_math</span> <span class="kn">import</span> <span class="n">atomic_element</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">atomic</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">adas_files</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">plot_tools</span>
<span class="kn">from</span> <span class="nn">scipy.integrate</span> <span class="kn">import</span> <span class="n">cumtrapz</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">constants</span>
<span class="kn">from</span> <span class="nn">IPython</span> <span class="kn">import</span> <span class="n">embed</span>
<span class="kn">import</span> <span class="nn">warnings</span><span class="o">,</span> <span class="nn">copy</span>

<div class="viewcode-block" id="compute_rad"><a class="viewcode-back" href="../../aurora.html#aurora.radiation.compute_rad">[docs]</a><span class="k">def</span> <span class="nf">compute_rad</span><span class="p">(</span><span class="n">imp</span><span class="p">,</span> <span class="n">nz</span><span class="p">,</span> <span class="n">ne</span><span class="p">,</span> <span class="n">Te</span><span class="p">,</span>
                <span class="n">n0</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">Ti</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ni</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">adas_files_sub</span> <span class="o">=</span> <span class="p">{},</span>
                <span class="n">prad_flag</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sxr_flag</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">thermal_cx_rad_flag</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">spectral_brem_flag</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Calculate radiation terms corresponding to a simulation result. The nz,ne,Te,n0,Ti,ni arrays</span>
<span class="sd">    are normally assumed to be given as a function of (time,nZ,space), but time and space may </span>
<span class="sd">    be substituted by other coordinates (e.g. R,Z)</span>
<span class="sd">    </span>
<span class="sd">    Result can be conveniently plotted with a time-slider using, for example</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        aurora.slider_plot(rhop,time, res[&#39;line_rad&#39;].transpose(1,2,0)/1e6,</span>
<span class="sd">            xlabel=r&#39;$\\rho_p$&#39;, ylabel=&#39;time [s]&#39;, </span>
<span class="sd">            zlabel=r&#39;$P_{rad}$ [$MW$]&#39;,</span>
<span class="sd">            plot_sum=True,</span>
<span class="sd">            labels=[f&#39;Ca$^{{{str(i)}}}$&#39; for i in np.arange(res[&#39;line_rad&#39;].shape[1])])</span>

<span class="sd">    All radiation outputs are given in :math:`W cm^{-3}`, consistently with units of :math:`cm^{-3}`</span>
<span class="sd">    given for inputs.</span>

<span class="sd">    Args:</span>
<span class="sd">        imp : str</span>
<span class="sd">             Impurity symbol, e.g. Ca, F, W</span>
<span class="sd">        nz : array (time, nZ, space) [:math:`cm^{-3}`]</span>
<span class="sd">            Dictionary with impurity density result, as given by :py:func:`~aurora.core.run_aurora` method.</span>
<span class="sd">        ne : array (time,space) [:math:`cm^{-3}`]</span>
<span class="sd">            Electron density on the output grids.</span>
<span class="sd">        Te : array (time,space) [eV]</span>
<span class="sd">            Electron temperature on the output grids.</span>


<span class="sd">    Keyword Args:</span>
<span class="sd">        n0 : array(time,space), optional [:math:`cm^{-3}`]</span>
<span class="sd">             Background neutral density (assumed of hydrogen-isotopes).</span>
<span class="sd">             This is only used if thermal_cx_rad_flag=True.</span>
<span class="sd">        Ti : array (time,space) [eV]</span>
<span class="sd">            Main ion temperature (assumed of hydrogen-isotopes). This is only used</span>
<span class="sd">            if thermal_cx_rad_flag=True. If not set, Ti is taken equal to Te. </span>
<span class="sd">        adas_files_sub : dict</span>
<span class="sd">            Dictionary containing ADAS file names for radiation calculations, possibly including keys</span>
<span class="sd">            &quot;plt&quot;,&quot;prb&quot;,&quot;prc&quot;,&quot;pls&quot;,&quot;prs&quot;,&quot;pbs&quot;,&quot;brs&quot;</span>
<span class="sd">            Any file names that are needed and not provided will be searched in the </span>
<span class="sd">            :py:meth:`~aurora.adas_files.adas_files_dict` dictionary. </span>
<span class="sd">        prad_flag : bool, optional</span>
<span class="sd">            If True, total radiation is computed (for each charge state and their sum)</span>
<span class="sd">        sxr_flag : bool, optional</span>
<span class="sd">            If True, soft x-ray radiation is computed (for the given &#39;pls&#39;,&#39;prs&#39; ADAS files)</span>
<span class="sd">        thermal_cx_rad_flag : bool, optional</span>
<span class="sd">            If True, thermal charge exchange radiation is computed.</span>
<span class="sd">        spectral_brem_flag : bool, optional</span>
<span class="sd">            If True, spectral bremstrahlung is computed (based on available &#39;brs&#39; ADAS file)</span>

<span class="sd">    Returns:</span>
<span class="sd">        res : dict</span>
<span class="sd">            Dictionary containing radiation terms, depending on the activated flags. </span>
<span class="sd">            The structure of the &quot;res&quot; dictionary is as follows.</span>

<span class="sd">        If prad_flag=True,</span>

<span class="sd">        res[&#39;line_rad&#39;] : array (nt,nZ,nr)- from ADAS &quot;plt&quot; files</span>
<span class="sd">            Excitation-driven line radiation for each impurity charge state.</span>
<span class="sd">        res[&#39;cont_rad&#39;] : array (nt,nZ,nr)- from ADAS &quot;prb&quot; files</span>
<span class="sd">            Continuum and line power driven by recombination and bremsstrahlung for impurity ions.</span>
<span class="sd">        res[&#39;brems&#39;] : array (nt,nr)- analytic formula. </span>
<span class="sd">            Bremsstrahlung produced by electron scarrering at fully ionized impurity </span>
<span class="sd">            This is only an approximate calculation and is more accurately accounted for in the </span>
<span class="sd">            &#39;cont_rad&#39; component.</span>
<span class="sd">        res[&#39;thermal_cx_cont_rad&#39;] : array (nt,nZ,nr)- from ADAS &quot;prc&quot; files</span>
<span class="sd">            Radiation deriving from charge transfer from thermal neutral hydrogen to impurity ions.</span>
<span class="sd">            Returned only if thermal_cx_rad_flag=True.</span>
<span class="sd">        res[&#39;tot&#39;] : array (nt,nZ,nr)</span>
<span class="sd">            Total unfilted radiation, summed over all charge states, given by the sum of all known </span>
<span class="sd">            radiation components.</span>

<span class="sd">        If sxr_flag=True,</span>

<span class="sd">        res[&#39;sxr_line_rad&#39;] : array (nt,nZ,nr)- from ADAS &quot;pls&quot; files</span>
<span class="sd">            Excitation-driven line radiation for each impurity charge state in the SXR range.</span>
<span class="sd">        res[&#39;sxr_cont_rad&#39;] : array (nt,nZ,nr)- from ADAS &quot;prs&quot; files</span>
<span class="sd">            Continuum and line power driven by recombination and bremsstrahlung for impurity ions</span>
<span class="sd">            in the SXR range. </span>
<span class="sd">        res[&#39;sxr_brems&#39;] : array (nt,nZ,nr)- from ADAS &quot;pbs&quot; files</span>
<span class="sd">            Bremsstrahlung produced by electron scarrering at fully ionized impurity in the SXR range.</span>
<span class="sd">        res[&#39;sxr_tot&#39;] : array (nt,nZ,nr)</span>
<span class="sd">            Total radiation in the SXR range, summed over all charge states, given by the sum of all known </span>
<span class="sd">            radiation components in the SXR range. </span>

<span class="sd">        If spectral_brem_flag,</span>

<span class="sd">        res[&#39;spectral_brems&#39;] : array (nt,nZ,nr) -- from ADAS &quot;brs&quot; files</span>
<span class="sd">            Bremsstrahlung at a specific wavelength, depending on provided &quot;brs&quot; file. </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">Z_imp</span> <span class="o">=</span> <span class="n">nz</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">logTe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">Te</span><span class="p">)</span>
    <span class="n">logne</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">ne</span><span class="p">)</span>

    <span class="c1"># calculate total radiation</span>
    <span class="k">if</span> <span class="n">prad_flag</span><span class="p">:</span>

        <span class="k">if</span> <span class="s1">&#39;plt&#39;</span> <span class="ow">in</span> <span class="n">adas_files_sub</span><span class="p">:</span>  <span class="c1"># check if user requested use of a specific file</span>
            <span class="n">atom_data</span> <span class="o">=</span> <span class="n">atomic</span><span class="o">.</span><span class="n">get_atom_data</span><span class="p">(</span><span class="n">imp</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;plt&#39;</span><span class="p">],[</span><span class="n">adas_files_sub</span><span class="p">[</span><span class="s1">&#39;plt&#39;</span><span class="p">]])</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># use default file from adas_files.adas_files_dict()</span>
            <span class="n">atom_data</span> <span class="o">=</span> <span class="n">atomic</span><span class="o">.</span><span class="n">get_atom_data</span><span class="p">(</span><span class="n">imp</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;plt&#39;</span><span class="p">])</span>
        <span class="n">pltt</span> <span class="o">=</span> <span class="n">atomic</span><span class="o">.</span><span class="n">interp_atom_prof</span><span class="p">(</span><span class="n">atom_data</span><span class="p">[</span><span class="s1">&#39;plt&#39;</span><span class="p">],</span><span class="n">logne</span><span class="p">,</span><span class="n">logTe</span><span class="p">)</span> <span class="c1"># W</span>

        <span class="k">if</span> <span class="s1">&#39;prb&#39;</span> <span class="ow">in</span> <span class="n">adas_files_sub</span><span class="p">:</span>
            <span class="n">atom_data</span> <span class="o">=</span> <span class="n">atomic</span><span class="o">.</span><span class="n">get_atom_data</span><span class="p">(</span><span class="n">imp</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;prb&#39;</span><span class="p">],[</span><span class="n">adas_files_sub</span><span class="p">[</span><span class="s1">&#39;prb&#39;</span><span class="p">]])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">atom_data</span> <span class="o">=</span> <span class="n">atomic</span><span class="o">.</span><span class="n">get_atom_data</span><span class="p">(</span><span class="n">imp</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;prb&#39;</span><span class="p">])</span>
        <span class="n">prb</span> <span class="o">=</span> <span class="n">atomic</span><span class="o">.</span><span class="n">interp_atom_prof</span><span class="p">(</span><span class="n">atom_data</span><span class="p">[</span><span class="s1">&#39;prb&#39;</span><span class="p">],</span><span class="n">logne</span><span class="p">,</span><span class="n">logTe</span><span class="p">)</span> <span class="c1"># W</span>

        <span class="c1"># line radiation for each charge state</span>
        <span class="n">res</span><span class="p">[</span><span class="s1">&#39;line_rad&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">nz</span><span class="p">[:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">pltt</span><span class="p">,</span> <span class="mf">1e-60</span><span class="p">)</span> <span class="c1"># no line rad for fully stripped ion       </span>

        <span class="c1"># total continuum radiation (NB: neutrals do not have continuum radiation)</span>
        <span class="n">res</span><span class="p">[</span><span class="s1">&#39;cont_rad&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nz</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span> <span class="o">*</span> <span class="n">prb</span>

        <span class="c1"># impurity brems (inaccurate Gaunt factor!) -- already included in &#39;cont_rad&#39;</span>
        <span class="n">res</span><span class="p">[</span><span class="s1">&#39;brems&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">atomic</span><span class="o">.</span><span class="n">impurity_brems</span><span class="p">(</span><span class="n">nz</span><span class="p">,</span> <span class="n">ne</span><span class="p">,</span> <span class="n">Te</span><span class="p">)</span>

        <span class="c1"># Total unfiltered radiation: </span>
        <span class="n">res</span><span class="p">[</span><span class="s1">&#39;tot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;line_rad&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;cont_rad&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> 

        <span class="k">if</span> <span class="n">thermal_cx_rad_flag</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">n0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;Requested thermal CX emission to be computed, &#39;</span>
                    <span class="s1">&#39;but no background neutral density was provided!&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">Ti</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Requested thermal CX emission to be computed &#39;</span>
                              <span class="s1">&#39;but no Ti values were provided! Setting Ti=Te&#39;</span><span class="p">,</span>
                              <span class="ne">RuntimeWarning</span><span class="p">)</span>
                <span class="n">Ti</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">Te</span><span class="p">)</span>

            <span class="c1"># make sure that n0 and Ti are given as 2D:</span>
            <span class="k">assert</span> <span class="n">n0</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">2</span> <span class="ow">and</span> <span class="n">Ti</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">2</span>
            
            <span class="n">logTi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">Ti</span><span class="p">)</span>
            
            <span class="c1"># thermal CX radiation to total recombination and continuum radiation terms:</span>
            <span class="k">if</span> <span class="s1">&#39;prc&#39;</span> <span class="ow">in</span> <span class="n">adas_files_sub</span><span class="p">:</span>
                <span class="n">atom_data</span> <span class="o">=</span> <span class="n">atomic</span><span class="o">.</span><span class="n">get_atom_data</span><span class="p">(</span><span class="n">imp</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;prc&#39;</span><span class="p">],[</span><span class="n">adas_files_sub</span><span class="p">[</span><span class="s1">&#39;prc&#39;</span><span class="p">]])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">atom_data</span> <span class="o">=</span> <span class="n">atomic</span><span class="o">.</span><span class="n">get_atom_data</span><span class="p">(</span><span class="n">imp</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;prc&#39;</span><span class="p">])</span>

            <span class="c1"># prc has weak dependence on density, so no difference between using ni or ne</span>
            <span class="n">prc</span> <span class="o">=</span> <span class="n">atomic</span><span class="o">.</span><span class="n">interp_atom_prof</span><span class="p">(</span><span class="n">atom_data</span><span class="p">[</span><span class="s1">&#39;prc&#39;</span><span class="p">],</span><span class="n">logne</span><span class="p">,</span><span class="n">logTi</span><span class="p">,</span><span class="n">x_multiply</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1"># W</span>

            <span class="c1"># broadcast n0 to dimensions (nt,nZ,nr):</span>
            <span class="n">res</span><span class="p">[</span><span class="s1">&#39;thermal_cx_cont_rad&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nz</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span> <span class="o">*</span> <span class="n">n0</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">prc</span>

            <span class="c1"># add to total unfiltered radiation:</span>
            <span class="n">res</span><span class="p">[</span><span class="s1">&#39;tot&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;thermal_cx_cont_rad&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                       
    <span class="k">if</span> <span class="n">sxr_flag</span><span class="p">:</span> <span class="c1"># SXR-filtered radiation (spectral range depends on filter used for files)</span>

        <span class="k">if</span> <span class="s1">&#39;pls&#39;</span> <span class="ow">in</span> <span class="n">adas_files_sub</span><span class="p">:</span>
            <span class="n">atom_data</span> <span class="o">=</span> <span class="n">atomic</span><span class="o">.</span><span class="n">get_atom_data</span><span class="p">(</span><span class="n">imp</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;pls&#39;</span><span class="p">],[</span><span class="n">adas_files_sub</span><span class="p">[</span><span class="s1">&#39;pls&#39;</span><span class="p">]])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">atom_data</span> <span class="o">=</span> <span class="n">atomic</span><span class="o">.</span><span class="n">get_atom_data</span><span class="p">(</span><span class="n">imp</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;pls&#39;</span><span class="p">])</span>
        <span class="n">pls</span> <span class="o">=</span> <span class="n">atomic</span><span class="o">.</span><span class="n">interp_atom_prof</span><span class="p">(</span><span class="n">atom_data</span><span class="p">[</span><span class="s1">&#39;pls&#39;</span><span class="p">],</span><span class="n">logne</span><span class="p">,</span><span class="n">logTe</span><span class="p">)</span> <span class="c1"># W</span>

        <span class="k">if</span> <span class="s1">&#39;prs&#39;</span> <span class="ow">in</span> <span class="n">adas_files_sub</span><span class="p">:</span>
            <span class="n">atom_data</span> <span class="o">=</span> <span class="n">atomic</span><span class="o">.</span><span class="n">get_atom_data</span><span class="p">(</span><span class="n">imp</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;prs&#39;</span><span class="p">],[</span><span class="n">adas_files_sub</span><span class="p">[</span><span class="s1">&#39;prs&#39;</span><span class="p">]])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">atom_data</span> <span class="o">=</span> <span class="n">atomic</span><span class="o">.</span><span class="n">get_atom_data</span><span class="p">(</span><span class="n">imp</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;prs&#39;</span><span class="p">])</span>
        <span class="n">prs</span> <span class="o">=</span> <span class="n">atomic</span><span class="o">.</span><span class="n">interp_atom_prof</span><span class="p">(</span><span class="n">atom_data</span><span class="p">[</span><span class="s1">&#39;prs&#39;</span><span class="p">],</span><span class="n">logne</span><span class="p">,</span><span class="n">logTe</span><span class="p">)</span> <span class="c1"># W</span>

        <span class="c1"># SXR line radiation for each charge state</span>
        <span class="n">res</span><span class="p">[</span><span class="s1">&#39;sxr_line_rad&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">nz</span><span class="p">[:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">pls</span><span class="p">,</span> <span class="mf">1e-60</span><span class="p">)</span>

        <span class="c1"># SXR continuum radiation for each charge state</span>
        <span class="n">res</span><span class="p">[</span><span class="s1">&#39;sxr_cont_rad&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nz</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span> <span class="o">*</span> <span class="n">prs</span>
    
        <span class="c1"># impurity bremsstrahlung in SXR range -- already included in &#39;sxr_cont_rad&#39;</span>
        <span class="k">if</span> <span class="s1">&#39;pbs&#39;</span> <span class="ow">in</span> <span class="n">adas_files_sub</span><span class="p">:</span>
            <span class="n">atom_data</span> <span class="o">=</span> <span class="n">atomic</span><span class="o">.</span><span class="n">get_atom_data</span><span class="p">(</span><span class="n">imp</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;pbs&#39;</span><span class="p">],[</span><span class="n">adas_files_sub</span><span class="p">[</span><span class="s1">&#39;pbs&#39;</span><span class="p">]])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">atom_data</span> <span class="o">=</span> <span class="n">atomic</span><span class="o">.</span><span class="n">get_atom_data</span><span class="p">(</span><span class="n">imp</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;pbs&#39;</span><span class="p">])</span>
        <span class="n">pbs</span> <span class="o">=</span> <span class="n">atomic</span><span class="o">.</span><span class="n">interp_atom_prof</span><span class="p">(</span><span class="n">atom_data</span><span class="p">[</span><span class="s1">&#39;pbs&#39;</span><span class="p">],</span><span class="n">logne</span><span class="p">,</span><span class="n">logTe</span><span class="p">)</span> <span class="c1"># W</span>
        <span class="n">res</span><span class="p">[</span><span class="s1">&#39;sxr_brems&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nz</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span> <span class="o">*</span> <span class="n">pbs</span> 

        <span class="c1"># SXR total radiation</span>
        <span class="n">res</span><span class="p">[</span><span class="s1">&#39;sxr_tot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;sxr_line_rad&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;sxr_cont_rad&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        
    <span class="k">if</span> <span class="n">spectral_brem_flag</span><span class="p">:</span>  <span class="c1"># spectral bremsstrahlung (i.e. brems at a specific wavelength)</span>

        <span class="k">if</span> <span class="s1">&#39;brs&#39;</span> <span class="ow">in</span> <span class="n">adas_files_sub</span><span class="p">:</span>
            <span class="n">atom_data</span> <span class="o">=</span> <span class="n">atomic</span><span class="o">.</span><span class="n">get_atom_data</span><span class="p">(</span><span class="n">imp</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;brs&#39;</span><span class="p">],[</span><span class="n">adas_files_sub</span><span class="p">[</span><span class="s1">&#39;brs&#39;</span><span class="p">]])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">atom_data</span> <span class="o">=</span> <span class="n">atomic</span><span class="o">.</span><span class="n">get_atom_data</span><span class="p">(</span><span class="n">imp</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;brs&#39;</span><span class="p">])</span>
        <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">tab</span> <span class="o">=</span> <span class="n">atom_data</span><span class="p">[</span><span class="s1">&#39;brs&#39;</span><span class="p">]</span>
        <span class="n">brs</span> <span class="o">=</span> <span class="n">atomic</span><span class="o">.</span><span class="n">interp_atom_prof</span><span class="p">((</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">tab</span><span class="o">.</span><span class="n">T</span><span class="p">),</span><span class="kc">None</span><span class="p">,</span><span class="n">logTe</span><span class="p">)</span> <span class="c1"># W</span>

        <span class="c1"># interpolate on Z grid of impurity of interest</span>
        <span class="n">logZ_rep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">Z_imp</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">brs</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">brs</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">assume_sorted</span><span class="o">=</span><span class="kc">True</span><span class="p">)(</span><span class="n">logZ_rep</span><span class="p">)</span>

        <span class="c1"># Note: no spectral bremsstrahlung from neutral stage</span>
        <span class="n">res</span><span class="p">[</span><span class="s1">&#39;spectral_brems&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nz</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span> <span class="o">*</span> <span class="n">brs</span>

    <span class="k">return</span> <span class="n">res</span></div>



<div class="viewcode-block" id="plot_radiation_profs"><a class="viewcode-back" href="../../aurora.html#aurora.radiation.plot_radiation_profs">[docs]</a><span class="k">def</span> <span class="nf">plot_radiation_profs</span><span class="p">(</span><span class="n">imp</span><span class="p">,</span> <span class="n">nz_prof</span><span class="p">,</span> <span class="n">logne_prof</span><span class="p">,</span> <span class="n">logTe_prof</span><span class="p">,</span> <span class="n">xvar_prof</span><span class="p">,</span>
                         <span class="n">xvar_label</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">atom_data</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Compute profiles of predicted radiation, both SXR-filtered and unfiltered.</span>
<span class="sd">    This function offers a simplified interface to radiation calculation with respect to </span>
<span class="sd">    :py:meth:`~aurora.radiation.compute_rad`, which is more complete.</span>

<span class="sd">    This function can be used to plot radial profiles (setting xvar_prof to a radial grid)</span>
<span class="sd">    or profiles as a function of any variable on which the logne_prof and logTe_prof</span>
<span class="sd">    may depend.</span>

<span class="sd">    The variable &quot;nz_prof&quot; may be a full description of impurity charge state densities</span>
<span class="sd">    (e.g. the output of aurora), or profiles of fractional abundances from ionization </span>
<span class="sd">    equilibrium.</span>

<span class="sd">    Args: </span>
<span class="sd">        imp : str, optional</span>
<span class="sd">            Impurity ion atomic symbol.</span>
<span class="sd">        nz_prof : array (TODO for docs: check dimensions)</span>
<span class="sd">            Impurity charge state densities</span>
<span class="sd">        logne_prof : array (TODO for docs: check dimensions)</span>
<span class="sd">            Electron density profiles in :math:`cm^{-3}`</span>
<span class="sd">        logTe_prof : array (TODO for docs: check dimensions)</span>
<span class="sd">            Electron temperature profiles in eV</span>
<span class="sd">        xvar_prof : array (TODO for docs: check dimensions)</span>
<span class="sd">            Profiles of a variable of interest, on the same grid as kinetic profiles. </span>
<span class="sd">        xvar_label : str, optional</span>
<span class="sd">            Label for x-axis. </span>
<span class="sd">        atom_data : dict, optional</span>
<span class="sd">            Dictionary containing atomic data as output by :py:meth:`~aurora.atomic.get_atom_data`</span>
<span class="sd">            for the atomic processes of interest. &quot;prs&quot;,&quot;pls&quot;,&quot;plt&quot; and &quot;prb&quot; are required by this function.</span>
<span class="sd">            If not provided, this function loads these files internally. </span>

<span class="sd">    Returns:</span>
<span class="sd">        pls : array (TODO for docs: check dimensions)</span>
<span class="sd">            SXR line radiation.</span>
<span class="sd">        prs : array (TODO for docs: check dimensions)</span>
<span class="sd">            SXR continuum radiation.</span>
<span class="sd">        pltt : array (TODO for docs: check dimensions)</span>
<span class="sd">            Unfiltered line radiation.</span>
<span class="sd">        prb : array (TODO for docs: check dimensions)</span>
<span class="sd">            Unfiltered continuum radiation.        </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">atom_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># if atom_data dictionary was not given, load appropriate default files</span>
        <span class="n">atom_data</span> <span class="o">=</span> <span class="n">atomic</span><span class="o">.</span><span class="n">get_atom_data</span><span class="p">(</span><span class="n">imp</span><span class="p">,[</span><span class="s1">&#39;pls&#39;</span><span class="p">,</span><span class="s1">&#39;prs&#39;</span><span class="p">,</span><span class="s1">&#39;plt&#39;</span><span class="p">,</span><span class="s1">&#39;prb&#39;</span><span class="p">])</span>

    <span class="c1"># use &quot;pltt&quot; nomenclature rather than &quot;plt&quot; to avoid issues with matplotlib.pyplot imported as plt</span>
    <span class="n">pls</span><span class="p">,</span> <span class="n">prs</span><span class="p">,</span> <span class="n">pltt</span><span class="p">,</span> <span class="n">prb</span> <span class="o">=</span> <span class="n">atomic</span><span class="o">.</span><span class="n">get_cooling_factors</span><span class="p">(</span><span class="n">atom_data</span><span class="p">,</span> <span class="n">logTe_prof</span><span class="p">,</span> <span class="n">nz_prof</span><span class="p">,</span> <span class="n">ion_resolved</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">emiss_sxr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">xvar_prof</span><span class="p">),</span><span class="n">nion</span><span class="p">))</span>
    <span class="n">emiss_tot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">xvar_prof</span><span class="p">),</span><span class="n">nion</span><span class="p">))</span>
    <span class="n">emiss_sxr</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span> <span class="p">]</span> <span class="o">+=</span> <span class="n">prs</span>
    <span class="n">emiss_sxr</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">pls</span>
    <span class="n">emiss_tot</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span> <span class="p">]</span> <span class="o">+=</span> <span class="n">prb</span>
    <span class="n">emiss_tot</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">pltt</span>

    <span class="c1"># plot radiation components</span>
    <span class="n">fig</span><span class="p">,</span><span class="n">axx</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span><span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axx</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">nion</span> <span class="o">=</span> <span class="n">prs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">plasma</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="n">nion</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">ax</span><span class="p">:</span>
        <span class="n">a</span><span class="o">.</span><span class="n">set_prop_cycle</span><span class="p">(</span><span class="s1">&#39;color&#39;</span><span class="p">,</span><span class="n">colors</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([],[])</span> <span class="c1">#empty plot for bremstrahlung of neutral ion</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xvar_prof</span><span class="p">,</span><span class="n">prs</span><span class="p">);</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;PRS: cont SXR rad&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xvar_prof</span><span class="p">,</span><span class="n">pls</span><span class="p">);</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;PLS: SXR line rad&#39;</span><span class="p">)</span>
    
    <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xvar_prof</span><span class="p">,</span><span class="n">pltt</span><span class="p">);</span> <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;PLT: tot line rad&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([],[])</span> <span class="c1">#empty plot for bremstrahlung of neutral ion</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xvar_prof</span><span class="p">,</span><span class="n">prb</span><span class="p">);</span> <span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;PRB: tot cont rad&#39;</span><span class="p">)</span>

    <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xvar_label</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xvar_label</span><span class="p">)</span>
    
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="sa">r</span><span class="s1">&#39;$</span><span class="si">%s</span><span class="s1">^{</span><span class="si">%d</span><span class="s1">\!+}$&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">imp</span><span class="p">,</span><span class="n">cc</span><span class="p">)</span> <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nion</span><span class="p">)]</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xvar_prof</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xvar_prof</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1"># plot total power (in SXR and whole range)</span>
    <span class="n">fig</span><span class="p">,</span><span class="n">axx</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span><span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axx</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">ax</span><span class="p">:</span>
        <span class="n">a</span><span class="o">.</span><span class="n">set_prop_cycle</span><span class="p">(</span><span class="s1">&#39;color&#39;</span><span class="p">,</span><span class="n">colors</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xvar_prof</span><span class="p">,</span><span class="n">emiss_sxr</span><span class="p">);</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;SXR power [W]&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xvar_prof</span><span class="p">,</span><span class="n">emiss_tot</span><span class="p">);</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Tot. rad. power [W]&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xvar_prof</span><span class="p">,</span><span class="n">emiss_sxr</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="n">logne_prof</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]);</span> <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;SXR power [W/m$^{-3}$]&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xvar_prof</span><span class="p">,</span><span class="n">emiss_tot</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="n">logne_prof</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]);</span> <span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Tot. rad. power [W/m$^{-3}$]&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xvar_label</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xvar_label</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xvar_prof</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xvar_prof</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">pls</span><span class="p">,</span> <span class="n">prs</span><span class="p">,</span> <span class="n">pltt</span><span class="p">,</span> <span class="n">prb</span></div>



<div class="viewcode-block" id="radiation_model"><a class="viewcode-back" href="../../aurora.html#aurora.radiation.radiation_model">[docs]</a><span class="k">def</span> <span class="nf">radiation_model</span><span class="p">(</span><span class="n">imp</span><span class="p">,</span><span class="n">rhop</span><span class="p">,</span> <span class="n">ne_cm3</span><span class="p">,</span> <span class="n">Te_eV</span><span class="p">,</span> <span class="n">vol</span><span class="p">,</span>
                    <span class="n">adas_files_sub</span><span class="o">=</span><span class="p">{},</span> <span class="n">n0_cm3</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Ti_eV</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nz_cm3</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Model radiation from a fixed-impurity-fraction model or from detailed impurity density</span>
<span class="sd">    profiles for the chosen ion. This method acts as a wrapper for :py:method:compute_rad(), </span>
<span class="sd">    calculating radiation terms over the radius and integrated over the plasma cross section. </span>

<span class="sd">    Args:</span>
<span class="sd">        imp : str (nr,)</span>
<span class="sd">            Impurity ion symbol, e.g. W</span>
<span class="sd">        rhop : array (nr,)</span>
<span class="sd">            Sqrt of normalized poloidal flux array from the axis outwards</span>
<span class="sd">        ne_cm3 : array (nr,)</span>
<span class="sd">            Electron density in :math:`cm^{-3}` units.</span>
<span class="sd">        Te_eV : array (nr,)</span>
<span class="sd">            Electron temperature in eV</span>
<span class="sd">        vol : array (nr,)</span>
<span class="sd">            Volume of each flux surface in :math:`m^3`. Note the units! We use :math:`m^3` here</span>
<span class="sd">            rather than :math:`cm^3` because it is more common to work with :math:`m^3` for </span>
<span class="sd">            flux surface volumes of fusion devices.</span>

<span class="sd">    Keyword Args:</span>
<span class="sd">        adas_files_sub : dict</span>
<span class="sd">            Dictionary containing ADAS file names for forward modeling and/or radiation calculations.</span>
<span class="sd">            Possibly useful keys include</span>
<span class="sd">            &quot;scd&quot;,&quot;acd&quot;,&quot;ccd&quot;,&quot;plt&quot;,&quot;prb&quot;,&quot;prc&quot;,&quot;pls&quot;,&quot;prs&quot;,&quot;pbs&quot;,&quot;brs&quot;</span>
<span class="sd">            Any file names that are needed and not provided will be searched in the </span>
<span class="sd">            :py:meth:`~aurora.adas_files.adas_files_dict` dictionary. </span>
<span class="sd">        n0_cm3 : array (nr,), optional</span>
<span class="sd">            Background ion density (H,D or T). If provided, charge exchange (CX) </span>
<span class="sd">            recombination is included in the calculation of charge state fractional </span>
<span class="sd">            abundances.</span>
<span class="sd">        Ti_eV : array (nr,), optional</span>
<span class="sd">            Background ion density (H,D or T). This is only used if CX recombination is </span>
<span class="sd">            requested, i.e. if n0_cm3 is not None. If not given, Ti is set equal to Te. </span>
<span class="sd">        nz_cm3 : array (nr,nz), optional</span>
<span class="sd">            Impurity charge state densities in :math:`cm^{-3}` units. Fractional abundancies can </span>
<span class="sd">            alternatively be specified via the :param:frac parameter for a constant-fraction</span>
<span class="sd">            impurity model across the radius. If provided, nz_cm3 is used. </span>
<span class="sd">        frac : float, optional</span>
<span class="sd">            Fractional abundance, with respect to ne, of the chosen impurity. </span>
<span class="sd">            The same fraction is assumed across the radial profile. If left to None,</span>
<span class="sd">            nz_cm3 must be given. </span>
<span class="sd">        plot : bool, optional</span>
<span class="sd">            If True, plot a number of diagnostic figures. </span>

<span class="sd">    Returns:</span>
<span class="sd">        res : dict</span>
<span class="sd">            Dictionary containing results of radiation model.     </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">nz_cm3</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">frac</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    
    <span class="c1"># limit all considerations to inside LCFS</span>
    <span class="n">ne_cm3</span> <span class="o">=</span> <span class="n">ne_cm3</span><span class="p">[</span><span class="n">rhop</span><span class="o">&lt;=</span><span class="mf">1.</span><span class="p">]</span>
    <span class="n">Te_eV</span> <span class="o">=</span> <span class="n">Te_eV</span><span class="p">[</span><span class="n">rhop</span><span class="o">&lt;=</span><span class="mf">1.</span><span class="p">]</span>
    <span class="n">vol</span> <span class="o">=</span> <span class="n">vol</span><span class="p">[</span><span class="n">rhop</span><span class="o">&lt;=</span><span class="mf">1.</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">n0_cm3</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">n0_cm3</span> <span class="o">=</span> <span class="n">n0_cm3</span><span class="p">[</span><span class="n">rhop</span><span class="o">&lt;=</span><span class="mf">1.</span><span class="p">]</span>
    <span class="n">rhop</span> <span class="o">=</span> <span class="n">rhop</span><span class="p">[</span><span class="n">rhop</span><span class="o">&lt;=</span><span class="mf">1.</span><span class="p">]</span>

    <span class="c1"># create results dictionary</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">out</span><span class="p">[</span><span class="s1">&#39;rhop&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rhop</span>
    <span class="n">out</span><span class="p">[</span><span class="s1">&#39;ne_cm3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ne_cm3</span>
    <span class="n">out</span><span class="p">[</span><span class="s1">&#39;Te_eV&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Te_eV</span>
    <span class="n">out</span><span class="p">[</span><span class="s1">&#39;vol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vol</span>
    <span class="k">if</span> <span class="n">n0_cm3</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">out</span><span class="p">[</span><span class="s1">&#39;n0_cm3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n0_cm3</span>
        
    <span class="c1"># load ionization and recombination rates</span>
    <span class="n">filetypes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;acd&#39;</span><span class="p">,</span><span class="s1">&#39;scd&#39;</span><span class="p">]</span>
    <span class="n">filenames</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">def_adas_files_dict</span> <span class="o">=</span> <span class="n">adas_files</span><span class="o">.</span><span class="n">adas_files_dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">filetype</span> <span class="ow">in</span> <span class="n">filetypes</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">filetype</span> <span class="ow">in</span> <span class="n">adas_files_sub</span><span class="p">:</span>
            <span class="n">filenames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">adas_files_sub</span><span class="p">[</span><span class="n">filetype</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filenames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">def_adas_files_dict</span><span class="p">[</span><span class="n">imp</span><span class="p">][</span><span class="n">filetype</span><span class="p">])</span>

    <span class="c1"># if background neutral density was given, load thermal CX rates too</span>
    <span class="k">if</span> <span class="n">n0_cm3</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">filetypes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;ccd&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;ccd&#39;</span> <span class="ow">in</span> <span class="n">adas_files_sub</span><span class="p">:</span>
            <span class="n">filenames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">adas_files_sub</span><span class="p">[</span><span class="s1">&#39;ccd&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filenames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">def_adas_files_dict</span><span class="p">[</span><span class="n">imp</span><span class="p">][</span><span class="s1">&#39;ccd&#39;</span><span class="p">])</span> 

    <span class="k">if</span> <span class="n">nz_cm3</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># obtain fractional abundances via a constant-fraction model </span>
        <span class="n">atom_data</span> <span class="o">=</span> <span class="n">atomic</span><span class="o">.</span><span class="n">get_atom_data</span><span class="p">(</span><span class="n">imp</span><span class="p">,</span><span class="n">filetypes</span><span class="p">,</span><span class="n">filenames</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">n0_cm3</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># obtain fractional abundances without CX:</span>
            <span class="n">logTe</span><span class="p">,</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;fz&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">atomic</span><span class="o">.</span><span class="n">get_frac_abundances</span><span class="p">(</span><span class="n">atom_data</span><span class="p">,</span><span class="n">ne_cm3</span><span class="p">,</span><span class="n">Te_eV</span><span class="p">,</span><span class="n">rho</span><span class="o">=</span><span class="n">rhop</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># include CX for ionization balance:</span>
            <span class="n">logTe</span><span class="p">,</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;fz&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">atomic</span><span class="o">.</span><span class="n">get_frac_abundances</span><span class="p">(</span><span class="n">atom_data</span><span class="p">,</span><span class="n">ne_cm3</span><span class="p">,</span><span class="n">Te_eV</span><span class="p">,</span><span class="n">rho</span><span class="o">=</span><span class="n">rhop</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span>
                                                   <span class="n">include_cx</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">n0_by_ne</span><span class="o">=</span><span class="n">n0_cm3</span><span class="o">/</span><span class="n">ne_cm3</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s1">&#39;logTe&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">logTe</span>
        
        <span class="c1"># Impurity densities</span>
        <span class="n">nz_cm3</span> <span class="o">=</span> <span class="n">frac</span> <span class="o">*</span> <span class="n">ne_cm3</span><span class="p">[</span><span class="kc">None</span><span class="p">,:,</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;fz&#39;</span><span class="p">][</span><span class="kc">None</span><span class="p">,:,:]</span>  <span class="c1"># (time,nZ,space)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># set input nz_cm3 into the right shape for compute_rad: (time,space,nz)</span>
        <span class="n">nz_cm3</span> <span class="o">=</span> <span class="n">nz_cm3</span><span class="p">[</span><span class="kc">None</span><span class="p">,:,:]</span>

        <span class="c1"># calculate fractional abundances </span>
        <span class="n">fz</span> <span class="o">=</span> <span class="n">nz_cm3</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">T</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">nz_cm3</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,:],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s1">&#39;fz&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fz</span><span class="o">.</span><span class="n">T</span>  <span class="c1"># (nz,space)</span>


    <span class="c1"># compute radiated power components for impurity species</span>
    <span class="n">rad</span> <span class="o">=</span> <span class="n">compute_rad</span><span class="p">(</span><span class="n">imp</span><span class="p">,</span> <span class="n">nz_cm3</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">ne_cm3</span><span class="p">[</span><span class="kc">None</span><span class="p">,:],</span> <span class="n">Te_eV</span><span class="p">[</span><span class="kc">None</span><span class="p">,:],</span>
                      <span class="n">n0</span><span class="o">=</span><span class="n">n0_cm3</span><span class="p">[</span><span class="kc">None</span><span class="p">,:]</span> <span class="k">if</span> <span class="n">n0_cm3</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">Ti</span><span class="o">=</span><span class="n">Te_eV</span><span class="p">[</span><span class="kc">None</span><span class="p">,:]</span> <span class="k">if</span> <span class="n">Ti_eV</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">Ti_eV</span><span class="p">[</span><span class="kc">None</span><span class="p">,:],</span>
                      <span class="n">adas_files_sub</span><span class="o">=</span><span class="n">adas_files_sub</span><span class="p">,</span>
                      <span class="n">prad_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sxr_flag</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="n">thermal_cx_rad_flag</span><span class="o">=</span><span class="kc">False</span> <span class="k">if</span> <span class="n">n0_cm3</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">True</span><span class="p">,</span>
                      <span class="n">spectral_brem_flag</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># radiation terms -- converted from W/cm^3 to W/m^3</span>
    <span class="n">out</span><span class="p">[</span><span class="s1">&#39;line_rad_dens&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rad</span><span class="p">[</span><span class="s1">&#39;line_rad&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,:,:]</span><span class="o">*</span><span class="mf">1e6</span>
    <span class="n">out</span><span class="p">[</span><span class="s1">&#39;cont_rad_dens&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rad</span><span class="p">[</span><span class="s1">&#39;cont_rad&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,:,:]</span><span class="o">*</span><span class="mf">1e6</span>
    <span class="n">out</span><span class="p">[</span><span class="s1">&#39;brems_dens&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rad</span><span class="p">[</span><span class="s1">&#39;brems&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,:,:]</span><span class="o">*</span><span class="mf">1e6</span>
    <span class="n">out</span><span class="p">[</span><span class="s1">&#39;rad_tot_dens&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rad</span><span class="p">[</span><span class="s1">&#39;tot&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,:]</span><span class="o">*</span><span class="mf">1e6</span>
    
    <span class="c1"># cumulative integral over all volume</span>
    <span class="n">out</span><span class="p">[</span><span class="s1">&#39;line_rad&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cumtrapz</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s1">&#39;line_rad_dens&#39;</span><span class="p">],</span> <span class="n">vol</span><span class="p">,</span> <span class="n">initial</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span>
    <span class="n">out</span><span class="p">[</span><span class="s1">&#39;line_rad_tot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cumtrapz</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s1">&#39;line_rad_dens&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">vol</span><span class="p">,</span> <span class="n">initial</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span>
    <span class="n">out</span><span class="p">[</span><span class="s1">&#39;cont_rad&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cumtrapz</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s1">&#39;cont_rad_dens&#39;</span><span class="p">],</span> <span class="n">vol</span><span class="p">,</span> <span class="n">initial</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span>
    <span class="n">out</span><span class="p">[</span><span class="s1">&#39;brems&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cumtrapz</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s1">&#39;brems_dens&#39;</span><span class="p">],</span> <span class="n">vol</span><span class="p">,</span> <span class="n">initial</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span>
    <span class="n">out</span><span class="p">[</span><span class="s1">&#39;rad_tot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cumtrapz</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s1">&#39;rad_tot_dens&#39;</span><span class="p">],</span> <span class="n">vol</span><span class="p">,</span> <span class="n">initial</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">n0_cm3</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">out</span><span class="p">[</span><span class="s1">&#39;thermal_cx_rad_dens&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rad</span><span class="p">[</span><span class="s1">&#39;thermal_cx_cont_rad&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,:,:]</span><span class="o">*</span><span class="mf">1e6</span>
        <span class="n">out</span><span class="p">[</span><span class="s1">&#39;thermal_cx_rad&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cumtrapz</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s1">&#39;thermal_cx_rad_dens&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">vol</span><span class="p">,</span> <span class="n">initial</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span>
        
    <span class="c1"># total power is the last element of the cumulative integral</span>
    <span class="n">out</span><span class="p">[</span><span class="s1">&#39;Prad&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;rad_tot&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;------------------------------------&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Total </span><span class="si">{</span><span class="n">imp</span><span class="si">}</span><span class="s1"> line radiation power: </span><span class="si">{</span><span class="n">out</span><span class="p">[</span><span class="s2">&quot;line_rad_tot&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">1e6</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> MW&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Total </span><span class="si">{</span><span class="n">imp</span><span class="si">}</span><span class="s1"> continuum radiation power: </span><span class="si">{</span><span class="n">out</span><span class="p">[</span><span class="s2">&quot;cont_rad&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">1e6</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> MW&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Total </span><span class="si">{</span><span class="n">imp</span><span class="si">}</span><span class="s1"> bremsstrahlung radiation power: </span><span class="si">{</span><span class="n">out</span><span class="p">[</span><span class="s2">&quot;brems&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">1e6</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> MW&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n0_cm3</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Thermal CX power: </span><span class="si">{</span><span class="n">out</span><span class="p">[</span><span class="s2">&quot;thermal_cx_rad&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">1e6</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> MW&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Total radiated power: </span><span class="si">{</span><span class="n">out</span><span class="p">[</span><span class="s2">&quot;Prad&quot;</span><span class="p">]</span><span class="o">/</span><span class="mf">1e6</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> MW&#39;</span><span class="p">)</span>

    <span class="c1"># calculate average charge state Z across radius</span>
    <span class="n">out</span><span class="p">[</span><span class="s1">&#39;Z_avg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s1">&#39;fz&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])[:,</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;fz&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="c1"># plot power in MW/m^3</span>
        <span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rhop</span><span class="p">,</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;line_rad_dens&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="mf">1e6</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$P_{rad,line}$&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rhop</span><span class="p">,</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;cont_rad_dens&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="mf">1e6</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$P_</span><span class="si">{cont}</span><span class="s1">$&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rhop</span><span class="p">,</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;brems_dens&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="mf">1e6</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$P_</span><span class="si">{brems}</span><span class="s1">$&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rhop</span><span class="p">,</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;rad_tot_dens&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">1e6</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$P_{rad,tot}$&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\rho_p$&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">imp</span><span class="si">}</span><span class="s1"> $P_</span><span class="si">{</span><span class="p">{</span><span class="n">rad</span><span class="p">}</span><span class="si">}</span><span class="s1">$ [$MW/m^3$]&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span><span class="o">.</span><span class="n">set_draggable</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="c1"># plot power in MW </span>
        <span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rhop</span><span class="p">,</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;line_rad&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="mf">1e6</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$P_{rad,line}$&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rhop</span><span class="p">,</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;cont_rad&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="mf">1e6</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$P_</span><span class="si">{cont}</span><span class="s1">$&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rhop</span><span class="p">,</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;brems&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="mf">1e6</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$P_</span><span class="si">{brems}</span><span class="s1">$&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rhop</span><span class="p">,</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;rad_tot&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">1e6</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$P_{rad,tot}$&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\rho_p$&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">imp</span><span class="si">}</span><span class="s1"> $P_</span><span class="si">{</span><span class="p">{</span><span class="n">rad</span><span class="p">}</span><span class="si">}</span><span class="s1">$ [MW]&#39;</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Cumulative power&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span><span class="o">.</span><span class="n">set_draggable</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        
        <span class="c1"># plot line radiation for each charge state</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
        <span class="n">colspan</span> <span class="o">=</span> <span class="mi">8</span> <span class="k">if</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;line_rad_dens&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">50</span> <span class="k">else</span> <span class="mi">7</span>
        <span class="n">a_plot</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="n">rowspan</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">colspan</span> <span class="o">=</span> <span class="n">colspan</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">)</span> 
        <span class="n">a_legend</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span><span class="n">rowspan</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">colspan</span> <span class="o">=</span> <span class="mi">10</span><span class="o">-</span><span class="n">colspan</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">)</span> 
        <span class="n">ls_cycle</span> <span class="o">=</span> <span class="n">plot_tools</span><span class="o">.</span><span class="n">get_ls_cycle</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">cs</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s1">&#39;line_rad_dens&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">ls</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">ls_cycle</span><span class="p">)</span>
            <span class="n">a_plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rhop</span><span class="p">,</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;line_rad_dens&#39;</span><span class="p">][</span><span class="n">cs</span><span class="p">,:]</span><span class="o">/</span><span class="mf">1e6</span><span class="p">,</span> <span class="n">ls</span><span class="p">)</span>
            <span class="n">a_legend</span><span class="o">.</span><span class="n">plot</span><span class="p">([],</span> <span class="p">[],</span> <span class="n">ls</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">imp</span><span class="o">+</span><span class="sa">fr</span><span class="s1">&#39;$^</span><span class="si">{</span><span class="p">{{</span><span class="n">cs</span><span class="p">}</span><span class="o">+</span><span class="p">}</span><span class="si">}</span><span class="s1">$&#39;</span><span class="p">)</span>
        <span class="n">a_plot</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\rho_p$&#39;</span><span class="p">)</span>
        <span class="n">a_plot</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">imp</span><span class="si">}</span><span class="s1"> $P_</span><span class="si">{</span><span class="p">{</span><span class="n">rad</span><span class="p">}</span><span class="si">}</span><span class="s1">$ [$MW/m^3$]&#39;</span><span class="p">)</span>
        <span class="n">ncol_leg</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;line_rad_dens&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">25</span> <span class="k">else</span> <span class="mi">3</span>
        <span class="n">leg</span><span class="o">=</span><span class="n">a_legend</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center right&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="n">ncol_leg</span><span class="p">)</span><span class="o">.</span><span class="n">set_draggable</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">a_legend</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
        
        <span class="c1"># plot average Z over radius</span>
        <span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rhop</span><span class="p">,</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;Z_avg&#39;</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\rho_p$&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">imp</span><span class="si">}</span><span class="s1"> $\langle Z \rangle$&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        
    <span class="k">return</span> <span class="n">out</span></div>



<div class="viewcode-block" id="get_main_ion_dens"><a class="viewcode-back" href="../../aurora.html#aurora.radiation.get_main_ion_dens">[docs]</a><span class="k">def</span> <span class="nf">get_main_ion_dens</span><span class="p">(</span><span class="n">ne_cm3</span><span class="p">,</span> <span class="n">ions</span><span class="p">,</span> <span class="n">rhop_plot</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Estimate the main ion density via quasi-neutrality. </span>
<span class="sd">    This requires subtracting from ne the impurity charge state density times Z for each </span>
<span class="sd">    charge state of every impurity present in the plasma in significant amounts. </span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        ne_cm3 : array (time,space)</span>
<span class="sd">            Electron density in :math:`cm^{-3}`</span>
<span class="sd">        ions : dict</span>
<span class="sd">            Dictionary with keys corresponding to the atomic symbol of each impurity under </span>
<span class="sd">            consideration. The values in ions[key] should correspond to the charge state </span>
<span class="sd">            densities for the selected impurity ion in :math:`cm^{-3}`, with shape </span>
<span class="sd">            (time,nZ,space). </span>
<span class="sd">        rhop_plot : array (space), optional</span>
<span class="sd">            rhop radial grid on which densities are given. If provided, plot densities of </span>
<span class="sd">            all species at the last time slice over this radial grid. </span>

<span class="sd">    Returns:</span>
<span class="sd">        ni_cm3 : array (time,space)</span>
<span class="sd">            Estimated main ion density in :math:`cm^{-3}`.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">ni_cm3</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">ne_cm3</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">imp</span> <span class="ow">in</span> <span class="n">ions</span><span class="p">:</span>
        <span class="c1"># extract charge state densities for given ion</span>
        <span class="n">nz_cm3</span> <span class="o">=</span> <span class="n">ions</span><span class="p">[</span><span class="n">imp</span><span class="p">]</span>
        
        <span class="n">Z_imp</span> <span class="o">=</span> <span class="n">nz_cm3</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># don&#39;t include neutral stage</span>
        <span class="n">Z_n_imp</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">Z_imp</span><span class="o">+</span><span class="mi">1</span><span class="p">)[</span><span class="kc">None</span><span class="p">,:,</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="n">nz_cm3</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ni_cm3</span> <span class="o">-=</span> <span class="n">Z_n_imp</span>

    <span class="k">if</span> <span class="n">rhop_plot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rhop_plot</span><span class="p">,</span> <span class="n">ne_cm3</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,:],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;electrons&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">imp</span> <span class="ow">in</span> <span class="n">ions</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rhop_plot</span><span class="p">,</span> <span class="n">ions</span><span class="p">[</span><span class="n">imp</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="n">imp</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\rho_p$&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$cm^{-3}$&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ni_cm3</span></div>



<div class="viewcode-block" id="adf04_files"><a class="viewcode-back" href="../../aurora.html#aurora.radiation.adf04_files">[docs]</a><span class="k">def</span> <span class="nf">adf04_files</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;Collection of trust-worthy ADAS ADF04 files. </span>
<span class="sd">    This function will be moved and expanded in ColRadPy in the near future. </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">files</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">files</span><span class="p">[</span><span class="s1">&#39;Ca&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">files</span><span class="p">[</span><span class="s1">&#39;Ca&#39;</span><span class="p">][</span><span class="s1">&#39;Ca8+&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;mglike_lfm14#ca8.dat&#39;</span>
    <span class="n">files</span><span class="p">[</span><span class="s1">&#39;Ca&#39;</span><span class="p">][</span><span class="s1">&#39;Ca9+&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nalike_lgy09#ca9.dat&#39;</span>
    <span class="n">files</span><span class="p">[</span><span class="s1">&#39;Ca&#39;</span><span class="p">][</span><span class="s1">&#39;Ca10+&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nelike_lgy09#ca10.dat&#39;</span>
    <span class="n">files</span><span class="p">[</span><span class="s1">&#39;Ca&#39;</span><span class="p">][</span><span class="s1">&#39;Ca11+&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;flike_mcw06#ca11.dat&#39;</span>
    <span class="n">files</span><span class="p">[</span><span class="s1">&#39;Ca&#39;</span><span class="p">][</span><span class="s1">&#39;Ca14+&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;clike_jm19#ca14.dat&#39;</span>
    <span class="n">files</span><span class="p">[</span><span class="s1">&#39;Ca&#39;</span><span class="p">][</span><span class="s1">&#39;Ca15+&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;blike_lgy12#ca15.dat&#39;</span>
    <span class="n">files</span><span class="p">[</span><span class="s1">&#39;Ca&#39;</span><span class="p">][</span><span class="s1">&#39;Ca16+&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;belike_lfm14#ca16.dat&#39;</span>
    <span class="n">files</span><span class="p">[</span><span class="s1">&#39;Ca&#39;</span><span class="p">][</span><span class="s1">&#39;Ca17+&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;lilike_lgy10#ca17.dat&#39;</span>
    <span class="n">files</span><span class="p">[</span><span class="s1">&#39;Ca&#39;</span><span class="p">][</span><span class="s1">&#39;Ca18+&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;helike_adw05#ca18.dat&#39;</span>

    <span class="k">return</span> <span class="n">files</span></div>




<div class="viewcode-block" id="get_pec_prof"><a class="viewcode-back" href="../../aurora.html#aurora.radiation.get_pec_prof">[docs]</a><span class="k">def</span> <span class="nf">get_pec_prof</span><span class="p">(</span><span class="n">ion</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">rhop</span><span class="p">,</span> <span class="n">ne_cm3</span><span class="p">,</span> <span class="n">Te_eV</span><span class="p">,</span> <span class="n">lam_nm</span><span class="o">=</span><span class="mf">1.8705</span><span class="p">,</span> <span class="n">lam_width_nm</span><span class="o">=</span><span class="mf">0.002</span><span class="p">,</span> <span class="n">meta_idxs</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                 <span class="n">adf04_repo</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;/adf04_files/ca/ca_adf04_adas/&#39;</span><span class="p">,</span>
                 <span class="n">pec_threshold</span><span class="o">=</span><span class="mf">1e-20</span><span class="p">,</span> <span class="n">phot2energy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Compute radial profile for Photon Emissivity Coefficients (PEC) for lines within the chosen</span>
<span class="sd">    wavelength range using the ColRadPy package. This is an alternative to the option of using </span>
<span class="sd">    the :py:func:`~atomic.read_adf15` function to read PEC data from an ADAS ADF-15 file and </span>
<span class="sd">    interpolate results on ne,Te grids. </span>

<span class="sd">    Args:</span>
<span class="sd">        ion : str</span>
<span class="sd">            Ion atomic symbol</span>
<span class="sd">        cs : str</span>
<span class="sd">            Charge state, given in format like &#39;Ca18+&#39;</span>
<span class="sd">        rhop : array (nr,)</span>
<span class="sd">            Srt of normalized poloidal flux radial array</span>
<span class="sd">        ne_cm3 : array (nr,)</span>
<span class="sd">            Electron density in :math:`cm^{-3}` units</span>
<span class="sd">        Te_eV : array (nr,)</span>
<span class="sd">            Electron temperature in eV units</span>
<span class="sd">        lam_nm : float</span>
<span class="sd">            Center of the wavelength region of interest [nm]</span>
<span class="sd">        lam_width_nm : float</span>
<span class="sd">            Width of the wavelength region of interest [nm]</span>
<span class="sd">        meta_idxs : list of integers</span>
<span class="sd">            List of levels in ADF04 file to be treated as metastable states. </span>
<span class="sd">        adf04_repo : str</span>
<span class="sd">            Location where ADF04 file from :py:method:adf04_files() should be fetched.</span>
<span class="sd">        prec_threshold : float</span>
<span class="sd">            Minimum value of PECs to be considered, in :math:`photons \cdot cm^3/s`</span>
<span class="sd">        phot2energy : bool</span>
<span class="sd">            If True, results are converted from :math:`photons \cdot cm^3/s` to :math:`W.cm^3`</span>
<span class="sd">        plot : bool</span>
<span class="sd">            If True, plot lines profiles and total</span>

<span class="sd">    Returns:</span>
<span class="sd">        pec_tot_prof : array (nr,)</span>
<span class="sd">            Radial profile of PEC intensity, in units of :math:`photons \cdot cm^3/s` (if phot2energy=False) or </span>
<span class="sd">            :math:`W \cdot cm^3` depending (if phot2energy=True). </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># temporarily import this here, until ColRadPy dependency can be set up properly</span>
        <span class="kn">from</span> <span class="nn">colradpy</span> <span class="kn">import</span> <span class="n">colradpy</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Could not import colradpy. Install this from the Github repo!&#39;</span><span class="p">)</span>
    
    <span class="n">files</span> <span class="o">=</span> <span class="n">adf04_files</span><span class="p">()</span>

    <span class="n">filepath</span> <span class="o">=</span> <span class="n">adf04_repo</span><span class="o">+</span><span class="n">files</span><span class="p">[</span><span class="n">ion</span><span class="p">][</span><span class="n">cs</span><span class="p">]</span>
    
    <span class="n">crm</span> <span class="o">=</span> <span class="n">colradpy</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">meta_idxs</span><span class="p">,</span> <span class="n">Te_eV</span><span class="p">,</span> <span class="n">ne_cm3</span><span class="p">,</span><span class="n">temp_dens_pair</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                   <span class="n">use_recombination</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="n">use_recombination_three_body</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    
    <span class="n">crm</span><span class="o">.</span><span class="n">make_ioniz_from_reduced_ionizrates</span><span class="p">()</span>
    <span class="n">crm</span><span class="o">.</span><span class="n">suppliment_with_ecip</span><span class="p">()</span>
    <span class="n">crm</span><span class="o">.</span><span class="n">make_electron_excitation_rates</span><span class="p">()</span>
    <span class="n">crm</span><span class="o">.</span><span class="n">populate_cr_matrix</span><span class="p">()</span>   <span class="c1"># time consuming step</span>
    <span class="n">crm</span><span class="o">.</span><span class="n">solve_quasi_static</span><span class="p">()</span>

    <span class="n">lams</span> <span class="o">=</span> <span class="n">crm</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;wave_vac&#39;</span><span class="p">]</span>
    <span class="n">lam_sel_idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">lams</span><span class="o">&gt;</span><span class="n">lam_nm</span><span class="o">-</span><span class="n">lam_width_nm</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">lams</span><span class="o">&lt;</span><span class="n">lam_nm</span><span class="o">+</span><span class="n">lam_width_nm</span><span class="o">/</span><span class="mf">2.</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">_lam_sel_nm</span> <span class="o">=</span> <span class="n">lams</span><span class="p">[</span><span class="n">lam_sel_idxs</span><span class="p">]</span>

    <span class="n">pecs</span> <span class="o">=</span> <span class="n">crm</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">][</span><span class="s1">&#39;pecs&#39;</span><span class="p">][</span><span class="n">lam_sel_idxs</span><span class="p">,</span><span class="mi">0</span><span class="p">,:]</span>  <span class="c1"># 0 index is for excitation component</span>
    <span class="n">pecs_sel_idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">pecs</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">&lt;</span><span class="n">pec_threshold</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">pecs_sel</span> <span class="o">=</span> <span class="n">pecs</span><span class="p">[</span><span class="n">pecs_sel_idxs</span><span class="p">,:]</span>
    <span class="n">lam_sel_nm</span> <span class="o">=</span> <span class="n">_lam_sel_nm</span><span class="p">[</span><span class="n">pecs_sel_idxs</span><span class="p">]</span>
    
    <span class="c1"># calculate total PEC profile</span>
    <span class="n">pec_tot_prof</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pecs_sel</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">phot2energy</span><span class="p">:</span>
        <span class="c1"># convert from photons.cm^3/s to W.cm^3</span>
        <span class="n">mults</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">h</span> <span class="o">*</span> <span class="n">constants</span><span class="o">.</span><span class="n">c</span> <span class="o">/</span> <span class="p">(</span><span class="n">lam_sel_nm</span><span class="o">*</span><span class="mf">1e-9</span><span class="p">)</span>
        <span class="n">pecs_sel</span> <span class="o">*=</span> <span class="n">mults</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span>
        <span class="n">pec_tot_prof</span> <span class="o">*=</span> <span class="n">mults</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span>
        
    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lam_sel_nm</span><span class="p">)):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rhop</span><span class="p">,</span> <span class="n">pecs_sel</span><span class="p">[</span><span class="n">ll</span><span class="p">,:],</span> <span class="n">label</span><span class="o">=</span><span class="sa">fr</span><span class="s1">&#39;$\lambda=</span><span class="si">{</span><span class="n">lam_sel_nm</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span><span class="si">:</span><span class="s1">.5f</span><span class="si">}</span><span class="s1">$ nm&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rhop</span><span class="p">,</span> <span class="n">pec_tot_prof</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Total&#39;</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">fr</span><span class="s1">&#39;$\lambda=</span><span class="si">{</span><span class="n">lam_nm</span><span class="si">}</span><span class="s1"> \pm </span><span class="si">{</span><span class="n">lam_width_nm</span><span class="o">/</span><span class="mf">2.</span><span class="si">}</span><span class="s1">$ nm&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\rho_p$&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;PEC [W cm$^3$]&#39;</span> <span class="k">if</span> <span class="n">phot2energy</span> <span class="k">else</span> <span class="s1">&#39;PEC [ph cm$^3$ s$^{-1}$]&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">set_draggable</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pec_tot_prof</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, F.Sciortino

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>